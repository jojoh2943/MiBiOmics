#-------------------------#
#### GENERAL FUNCTIONS ####
#-------------------------#

TSS.divide = function(x){
  x/sum(x)
}

'%!in%' <- function(x,y)!('%in%'(x,y)) 

euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))

normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}


## Specific functions: PLS and VIP Scores
VIPjh <- function(object, j, h) {
  if (object$method != "oscorespls")
    stop("Only implemented for orthogonal scores algorithm")
  if (nrow(object$Yloadings) > 1)
    stop("Only implemented for single-response models")
  
  b <- c(object$Yloadings)[1:h]
  T <- object$scores[,1:h, drop = FALSE]
  SS <- b^2 * colSums(T^2)
  W <- object$loading.weights[,1:h, drop = FALSE]
  Wnorm2 <- colSums(W^2)
  sqrt(nrow(W) * sum(SS * W[j,]^2 / Wnorm2) / sum(SS))
}
#Function for hive plot
vector_geom_curve <- function(edge_df, df_ggplot){
  vector_x <- c()
  vector_y <- c()
  label_fromNode <- c()
  vector_xend <- c()
  vector_yend <-c()
  label_toNode <- c()
  for (i in 1:nrow(edge_df)){
    x <- df_ggplot$x1[which(df_ggplot$label == edge_df$fromNode[i])]
    label_fromNode_ind <- edge_df$fromNode[i]
    y = 0
    xend = 0
    yend <-df_ggplot$y2[which(df_ggplot$label == edge_df$toNode[i])]
    label_toNode_ind <- edge_df$toNode[i]
    vector_x <- c(vector_x, x)
    vector_y <- c(vector_y, y)
    label_fromNode <- c(label_fromNode, label_fromNode_ind)
    label_toNode <- c(label_toNode, label_toNode_ind)
    vector_xend <- c(vector_xend, xend)
    vector_yend <-c(vector_yend, yend)
  }
  df_geom_curve <- data.frame(label_fromNode, vector_x, vector_y, label_toNode, vector_xend, vector_yend)
  return(df_geom_curve)
}

#-----------------------------------#
#### FUNCTION: REPORT GENERATION ####
#-----------------------------------#


write_report <- function(filePath, datasets, vector_input){
  
  fichier <- file("report.Rmd")
  print(vector_input)
  #Calculate number of files contained in the analysis
  switch(datasets[["type"]],
         "S"={
           text_FileDescription <- paste("For this analysis 2 files were imported: a counting table and an annotation table")
           PCoA_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text <- paste(PCoA_text, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                "\n\n```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10}\n",
                                "ggplot(data = PCoA,\n",
                                "aes_string(x = colnames(PCoA)[1], y = colnames(PCoA)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                "geom_point(size = 2) +\n",
                                "labs(x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA$eig[1] / sum(dudi_PCoA$eig), 2)),\n",
                                "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA$eig[2] / sum(dudi_PCoA$eig), 2)))\n",
                                "```\n",
                                sep = ""
             )
           }
           
           dendro_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text <- paste(dendro_text, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                  "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                  "ggdendrogram(dendrogramme, label = FALSE) +\n",
                                  " geom_text(data = info_dendrogramme,\n",
                                  "            aes_string(label = colnames(info_dendrogramme[3]), x = colnames(info_dendrogramme[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                  "           angle = 75,\n",
                                  "            vjust = 0,\n",
                                  "            nudge_y = -0.1,\n",
                                  "            size = 3) +\n",
                                  "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_P2']])) +\n",
                                  "  ylim(-0.15, NA)\n",
                                  "\n\n",
                                  "```\n")
           }
           
           TMM_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
               TMM_P4 <- paste(TMM_P4, "\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
               TMM_P4 <- paste(TMM_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10, warning = FALSE}\n", sep = "")
               
               TMM_P4 <- paste(TMM_P4, "colnames(geneTraitSignificance) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                               "for (module in 1:length(MEs)){\n",
                               "  module_name <- substring(names(MEs)[module], 3)\n",
                               "  column = paste(\"MM\",module_name, sep = \"\")\n",
                               "  column2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                               "  moduleGenes = (dynamicColors==module_name)\n",
                               "  a <- abs(geneModuleMembership[moduleGenes, column])\n",
                               "  b <- abs(geneTraitSignificance[moduleGenes, column2])\n",
                               "  TraitModuleMembership <- data.frame(a,b)\n",
                               "  colnames(TraitModuleMembership) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                               "  pv = corPvalueStudent(cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]), method= list_input[['cor_P4']], use=\"na.or.complete\"), length(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  Correlation <- cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  text_trait_module_membership = paste(\"Corr = \", round(Correlation, 2), \"\nP-val = \", pv)\n",
                               
                               "   print(ggplot(TraitModuleMembership, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                               "     geom_point(color = module_name) +\n",
                               "     geom_smooth(method=lm, color = \"white\") +\n",
                               "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                               "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership ,sep = \"\")) +\n",
                               "     geom_density_2d(color = '#E69F00'))\n",
                               "}\n",
                               sep = "")
               TMM_P4 <- paste(TMM_P4, "```\n\n", sep = "")
             }
           }
           
         },
         "ST"={
           numberOfFile <- 3
           text_FileDescription <- paste("For this analysis 3 files were imported: a counting table, a taxonomic annotation table describing the OTUs of the counting table and an annotation table")
           Rel_Ab_P2 <- "## Relative Abundance (First dataset) {.tabset .tabset-fade .tabset-pills} \n"
           Rel_Ab_P2_inside_tabSet <- ""
           for (col in 1:ncol(datasets[["taxaTable"]])){
             Rel_Ab_P2_inside_tabSet <- paste(Rel_Ab_P2_inside_tabSet,
                                              "\n### ", colnames(datasets[["taxaTable"]])[col],"\n\n",
                                              "```{r, echo = FALSE, message= FALSE, warning = FALSE, fig.height= 15, fig.width = 15} \n",
                                              "  taxTable_relAb <- taxTable\n",
                                              "  taxTable_relAb$rn <- colnames(exprDat)\n", 
                                              "if (list_treatment[['transformation']] == \"CLR\"){\n",
                                              "exprDat_rel_ab <- clrInv(exprDat)\n",
                                              "}else{\n",
                                              "exprDat_rel_ab <- as.data.frame(t(apply(exprDat, 1, function(x) x / sum(x))))\n",
                                              "}\n",
                                              "  exprDat_rel_ab_setTD <- setDT(as.data.frame(t(exprDat_rel_ab)), keep.rownames = TRUE)\n",
                                              "  exprDat_rel_ab_setTD <- merge(exprDat_rel_ab_setTD, taxTable_relAb)\n",
                                              "  exprDat_Relative_abundance <- melt(exprDat_rel_ab_setTD)\n",
                                              
                                              "  ggplot(exprDat_Relative_abundance, aes_string(x = 'variable', y = 'value', fill = '",colnames(datasets[["taxaTable"]])[col],"')) +\n",
                                              "    geom_bar(stat = 'identity') +\n",
                                              "    labs(x = 'Samples', \n",
                                              "         y = 'Relative Abundance', \n",
                                              "         title = paste('Relative abundance at the ", colnames(datasets[["taxaTable"]])[col]," Taxonomic level', sep = '')) +\n",
                                              "    theme(axis.text.x = element_text(angle = 90, hjust = 1))\n",
                                              "```\n", sep = ""
             )
           }
           Rel_Ab_P2 <- paste(Rel_Ab_P2, Rel_Ab_P2_inside_tabSet, sep = "")
           PCoA_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text <- paste(PCoA_text, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                "\n\n```{r, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15, warning = FALSE}\n",
                                "ggplot(data = PCoA,\n",
                                "aes_string(x = colnames(PCoA)[1], y = colnames(PCoA)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                "geom_point(size = 2) +\n",
                                "labs( x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA$eig[1] / sum(dudi_PCoA$eig), 2)),\n",
                                "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA$eig[2] / sum(dudi_PCoA$eig), 2)))\n",
                                "```\n",
                                sep = ""
             )
           }
           dendro_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text <- paste(dendro_text, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                  "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                  "ggdendrogram(dendrogramme, label = FALSE) +\n",
                                  " geom_text(data = info_dendrogramme,\n",
                                  "            aes_string(label = colnames(info_dendrogramme[3]), x = colnames(info_dendrogramme[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                  "           angle = 75,\n",
                                  "            vjust = 0,\n",
                                  "            nudge_y = -0.1,\n",
                                  "            size = 3) +\n",
                                  "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_P2']])) +\n",
                                  "  ylim(-0.15, NA)\n",
                                  "\n\n",
                                  "```\n")
           }
           
           Rel_Ab_P4 <- "## Relative abundance of each module {.tabset .tabset-fade .tabset-pills} \n"
           
           for (col in 1:ncol(datasets[["taxaTable"]])){
             Rel_Ab_P4 <- paste(Rel_Ab_P4, "### Relative abundance of modules at the ", colnames(datasets[["taxaTable"]])[col], " level\n\n", sep ="")
             Rel_Ab_P4 <- paste(Rel_Ab_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15, warning = FALSE}\n",
                                
                                "for (module in 1:length(MEs)){\n",
                                "  module_name <- substring(names(MEs)[module], 3)\n",
                                "  modGenes = dynamicColors == module_name \n",
                                "  selectedExpr <- exprDat[,modGenes]\n",
                                "if (list_treatment[['transformation']] == \"CLR\"){\n",
                                "exprDat_rel_ab <- clrInv(selectedExpr)\n",
                                "}else{\n",
                                "exprDat_rel_ab <- as.data.frame(t(apply(selectedExpr, 1, function(x) x / sum(x))))\n",
                                "}\n",
                                "  exprDat_rel_ab_setTD <- setDT(as.data.frame(t(exprDat_rel_ab)), keep.rownames = TRUE)\n",
                                "  exprDat_rel_ab_setTD <- merge(exprDat_rel_ab_setTD, taxTable_relAb, by = \"rn\")\n",
                                "  exprDat_rel_ab_setTD$rn <- as.character(exprDat_rel_ab_setTD$rn)\n",
                                "  exprDat_rel_ab_setTD$rn <- factor(exprDat_rel_ab_setTD$rn, levels = unique(exprDat_rel_ab_setTD$rn))\n",
                                "  melted_exprDat_rel_ab <- melt(exprDat_rel_ab_setTD)\n\n",
                                "  if (!is.na(unique(melted_exprDat_rel_ab$", colnames(datasets[["taxaTable"]])[col], ")[1] )){\n",
                                "  print(ggplot(melted_exprDat_rel_ab, aes_string(x = \"variable\", y = \"value\", fill =\"", colnames(datasets[["taxaTable"]])[col],"\")) +\n",
                                "    geom_bar(stat = \"identity\") +\n",
                                "    labs(x = \"Samples\", y = \"Relative Abundance\", title = paste(\"Relative abundance at the ",  colnames(datasets[["taxaTable"]])[col]," Taxonomic level of the \", module_name, \" module.\")) +\n",
                                "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
                                "  }else{\n",
                                "    if (length(unique(melted_exprDat_rel_ab$", colnames(datasets[["taxaTable"]])[col], ") ) > 1 ){\n",
                                "      print(ggplot(melted_exprDat_rel_ab, aes_string(x = \"variable\", y = \"value\", fill =\"", colnames(datasets[["taxaTable"]])[col],"\")) +\n",
                                "        geom_bar(stat = \"identity\") +\n",
                                "        labs(x = \"Samples\", y = \"Relative Abundance\", title = paste(\"Relative abundance at the ",  colnames(datasets[["taxaTable"]])[col]," Taxonomic level of the \", module_name, \" module.\")) +\n",
                                "        theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
                                "  }\n",
                                "  }\n",
                                "}\n",
                                "```\n\n",
                                sep= ""
                                
             )
           }
           TMM_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
               TMM_P4 <- paste(TMM_P4, "\n\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
               TMM_P4 <- paste(TMM_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10, warning = FALSE}\n", sep = "")
               
               TMM_P4 <- paste(TMM_P4, "colnames(geneTraitSignificance) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                               "for (module in 1:length(MEs)){\n",
                               "  module_name <- substring(names(MEs)[module], 3)\n",
                               "  column = paste(\"MM\",module_name, sep = \"\")\n",
                               "  column2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                               "  moduleGenes = (dynamicColors==module_name)\n",
                               "  a <- abs(geneModuleMembership[moduleGenes, column])\n",
                               "  b <- abs(geneTraitSignificance[moduleGenes, column2])\n",
                               "  TraitModuleMembership <- data.frame(a,b)\n",
                               "  colnames(TraitModuleMembership) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                               "  pv = corPvalueStudent(cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]), method= list_input[['cor_P4']], use=\"na.or.complete\"), length(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  Correlation <- cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  text_trait_module_membership = paste(\"Corr = \", round(Correlation, 2), \"\nP-val = \", pv)\n",
                               
                               "   print(ggplot(TraitModuleMembership, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                               "     geom_point(color = module_name) +\n",
                               "     geom_smooth(method=lm, color = \"white\") +\n",
                               "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                               "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership ,sep = \"\")) +\n",
                               "     geom_density_2d(color = '#E69F00'))\n",
                               "}\n",
                               sep = "")
               TMM_P4 <- paste(TMM_P4, "```\n\n", sep = "")
             }
           }
           
           HIVE_PLOT <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             HIVE_PLOT <- paste(HIVE_PLOT, "\n\n### HIVE PLOT representing correlation to ", colnames(datasets[["sampleAnnot"]])[col]," Trait\n\n", sep = "")
             HIVE_PLOT <- paste(HIVE_PLOT,
########################################
                                "```{r, echo = FALSE, message = FALSE, , fig.height= 20, fig.width = 20}\n",
                                "for (module in 1:length(MEs)){\n",
                                "ModuleName <- substring(names(MEs)[module], 3)\n",
                                "markers <- colnames(exprDat)[dynamicColors==ModuleName]\n",
                                "markers.data <- exprDat[,markers]\n",
                                "if (!is.numeric(sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col], "\"])){\n",
                                "  sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col], "\"] <- as.numeric(as.factor(sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col], "\"]))\n",
                                "}\n",
                                "env = as.data.frame(sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col], "\"])\n",
                                "colnames(env) = \"", colnames(datasets[["sampleAnnot"]])[col], "\"\n",
                                "markers.data.env <- data.frame(cbind(markers.data, env))\n",
                                "if (length(colnames(exprDat)[dynamicColors==ModuleName]) >= 10){\n",
                                "  ncomp=10\n",
                                "}else{\n",
                                "  ncomp=length(colnames(exprDat)[dynamicColors==ModuleName])\n",
                                "}\n",
                                "formulaChar <- paste(\"", colnames(datasets[["sampleAnnot"]])[col], "\", \"~.\", sep =\"\") \n",
                                "fit = plsr(formula(formulaChar), data=markers.data.env, validation=\"LOO\", method = \"oscorespls\", ncomp=ncomp)\n",
                                "cverr <- RMSEP(fit)$val[1,,]\n",
                                "imin <- which.min(cverr) - 1\n",
                                "myComp <- as.integer(imin)\n",
                                "if (myComp != 0){ \n",
                                "myFit = plsr(formula(formulaChar), data=markers.data.env, validation=\"LOO\", method = \"oscorespls\", ncomp=myComp)\n",
                                "cvs = round( cor(myFit$val$pred[,,myComp], markers.data.env[[\"", colnames(datasets[["sampleAnnot"]])[col], "\"]][!is.na(markers.data.env[[\"", colnames(datasets[["sampleAnnot"]])[col], "\"]])]), digits=3);\n",
                                "vip = vector(\"numeric\", ncol(markers.data)); for(j in 1:ncol(markers.data))  vip[j] <- VIPjh(myFit, j, myComp)\n",
                                "vip = round(vip, digits=2)\n",
                                "o = order(vip, decreasing=TRUE)\n",
                                "vip.df <- data.frame(Marker = colnames(markers.data), VIP = vip, Temp.Cor = geneTraitSignificance[colnames(markers.data),])\n",
                                "colnames(vip.df) <- c(\"Marker\", \"VIP\", c(colnames(sampleAnnot)))\n",
                                
                                "probes <- colnames(exprDat)\n",
                                "inModule <- is.finite(match(dynamicColors, ModuleName))\n",
                                "modProbes <- probes[inModule]\n",
                                "modTOM <- dissTOM[inModule, inModule]\n",
                                "dimnames(modTOM) <- list(modProbes, modProbes)\n",
                                "cyt <- exportNetworkToCytoscape(modTOM, edgeFile = NULL, nodeFile = NULL, weighted = TRUE, nodeNames = modProbes, nodeAttr = dynamicColors[inModule])\n",
                                "col <- 2 + as.numeric(", col,")\n",
                                "if (col != 12 && ModuleName != \"white\"){ \n",
                                "Annot <- taxTable[which(taxTable[[\"rn\"]] %in% rownames(vip.df)), ]\n",
                                "df.hive.plot <- data.frame(label = rownames(vip.df), x1 = vip.df[[\"VIP\"]], x2 = rep(0, nrow(vip.df)), y1 = rep(0, nrow(vip.df)), y2 = vip.df[[col]], annotation = Annot)\n",
                                "edgeData <- cyt$`edgeData`\n",
                                "df.hive.to.plot <- vector_geom_curve(edgeData, df.hive.plot)\n",

                                "print(cvs)\n",
                                "plot(myFit, ncomp=myComp, asp=1, line=TRUE)\n",

                                "  print(ggplot() +\n",
                                "    geom_point(data = df.hive.plot, aes(x1, y1, color = annotation.Family, size = 3)) + # x1 is the VIP\n",
                                "    geom_text(data = df.hive.plot, vjust = 0.5, angle = 45, aes(x1, y1, label = annotation.Family)) +\n",
                                "    geom_point(data = df.hive.plot, aes(x2, abs(y2), color = annotation.Family, size = 3)) + # y2 is the correlation to the pH at time of filtering\n",
                                "    geom_text(data = df.hive.plot, hjust = 0.5, angle = 45, aes(x2,abs(y2), label = annotation.Family)) + \n",
                                "    geom_curve(data = df.hive.to.plot, curvature = 0.2, color = \"grey \", size = 0.2,aes(x = vector_x, y = vector_y, xend = vector_xend, yend = abs(vector_yend))) +\n",
                                "    theme_gdocs() +\n",
                                "    scale_colour_tableau(palette = \"Tableau 20\") +\n",
                                "    labs(x = paste(\"VIP module\", ModuleName, \" \"), y = paste(\"Spearman Correlation to\", \"", colnames(datasets[["sampleAnnot"]])[col], "\"), colour = \"Annotation.Family\"))\n",
                                "}\n",
                                "}\n",
                                "}\n",
                                "```\n\n",



                                
                                sep = "")


             }

           

           },
         "M"={
           numberOfFile <- 3
           text_FileDescription <- paste("For this analysis 3 files were imported: a counting table, a second counting table and an annotation table")
           PCoA_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text <- paste(PCoA_text, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                "\n\n```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10}\n",
                                "ggplot(data = PCoA,\n",
                                "aes_string(x = colnames(PCoA)[1], y = colnames(PCoA)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                "geom_point(size = 2) +\n",
                                "labs(x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA$eig[1] / sum(dudi_PCoA$eig), 2)),\n",
                                "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA$eig[2] / sum(dudi_PCoA$eig), 2)))\n",
                                "```\n",
                                sep = ""
             )
           }
           PCoA_text_D2 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text_D2 <- paste(PCoA_text_D2, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                "\n\n```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10}\n",
                                "ggplot(data = PCoA_D2,\n",
                                "aes_string(x = colnames(PCoA_D2)[1], y = colnames(PCoA_D2)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                "geom_point(size = 2) +\n",
                                "labs(x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA_D2$eig[1] / sum(dudi_PCoA_D2$eig), 2)),\n",
                                "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA_D2$eig[2] / sum(dudi_PCoA_D2$eig), 2)))\n",
                                "```\n",
                                sep = ""
             )
           }
           dendro_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text <- paste(dendro_text, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                  "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                  "ggdendrogram(dendrogramme, label = FALSE) +\n",
                                  " geom_text(data = info_dendrogramme,\n",
                                  "            aes_string(label = colnames(info_dendrogramme[3]), x = colnames(info_dendrogramme[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                  "           angle = 75,\n",
                                  "            vjust = 0,\n",
                                  "            nudge_y = -0.1,\n",
                                  "            size = 3) +\n",
                                  "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_P2']])) +\n",
                                  "  ylim(-0.15, NA)\n",
                                  "\n\n",
                                  "```\n")
           }
           
           dendro_text_D2 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text_D2 <- paste(dendro_text_D2, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                  "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                  "ggdendrogram(dendrogramme_D2, label = FALSE) +\n",
                                  " geom_text(data = info_dendrogramme_D2,\n",
                                  "            aes_string(label = colnames(info_dendrogramme_D2[3]), x = colnames(info_dendrogramme_D2[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                  "           angle = 75,\n",
                                  "            vjust = 0,\n",
                                  "            nudge_y = -0.1,\n",
                                  "            size = 3) +\n",
                                  "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_D2_P2']])) +\n",
                                  "  ylim(-0.15, NA)\n",
                                  "\n\n",
                                  "```\n")
           }
           TMM_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
               TMM_P4 <- paste(TMM_P4, "\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
               TMM_P4 <- paste(TMM_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10}\n", sep = "")
               
               TMM_P4 <- paste(TMM_P4, "colnames(geneTraitSignificance) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                               "for (module in 1:length(MEs)){\n",
                               "  module_name <- substring(names(MEs)[module], 3)\n",
                               "  column = paste(\"MM\",module_name, sep = \"\")\n",
                               "  column2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                               "  moduleGenes = (dynamicColors==module_name)\n",
                               "  a <- abs(geneModuleMembership[moduleGenes, column])\n",
                               "  b <- abs(geneTraitSignificance[moduleGenes, column2])\n",
                               "  TraitModuleMembership <- data.frame(a,b)\n",
                               "  colnames(TraitModuleMembership) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                               "  pv = corPvalueStudent(cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]), method= list_input[['cor_P4']], use=\"na.or.complete\"), length(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  Correlation <- cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  text_trait_module_membership = paste(\"Corr = \", round(Correlation, 2), \"\nP-val = \", pv)\n",
                               
                               "   print(ggplot(TraitModuleMembership, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                               "     geom_point(color = module_name) +\n",
                               "     geom_smooth(method=lm, color = \"white\") +\n",
                               "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                               "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership ,sep = \"\")) +\n",
                               "     geom_density_2d(color = '#E69F00'))\n",
                               "}\n",
                               sep = "")
               TMM_P4 <- paste(TMM_P4, "```\n\n", sep = "")
             }
           }
           
           TMM_D2_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
             TMM_D2_P4 <- paste(TMM_D2_P4, "\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
             TMM_D2_P4 <- paste(TMM_D2_P4, "```{r}\n", sep = "")
             
             TMM_D2_P4 <- paste(TMM_D2_P4, "colnames(geneTraitSignificance) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                                "for (module in 1:length(MEs_D2)){\n",
                                "  module_name <- substring(names(MEs_D2)[module], 3)\n",
                                "  column_D2 = paste(\"MM\",module_name, sep = \"\")\n",
                                "  column2_D2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                                "  moduleGenes_D2 = (dynamicColors_D2==module_name)\n",
                                "  a_D2 <- abs(geneModuleMembership_D2[moduleGenes_D2, column_D2])\n",
                                "  b_D2 <- abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2])\n",
                                "  TraitModuleMembership_D2 <- data.frame(a_D2,b_D2)\n",
                                "  colnames(TraitModuleMembership_D2) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                                "  pv_D2 = corPvalueStudent(cor(abs(geneModuleMembership_D2[moduleGenes_D2, column_D2]), abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]), method= list_input[['cor_D2_P4']], use=\"na.or.complete\"), length(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]))\n",
                                "  Correlation_D2 <- cor(abs(geneModuleMembership_D2[moduleGenes_D2, column_D2]), abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]))\n",
                                "  text_trait_module_membership_D2 = paste(\"Corr = \", round(Correlation_D2, 2), \"\nP-val = \", pv_D2)\n",
                                "   print(ggplot(TraitModuleMembership_D2, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                                "     geom_point(color = module_name) +\n",
                                "     geom_smooth(method=lm, color = \"white\") +\n",
                                "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                                "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership_D2 ,sep = \"\")) +\n",
                                "     geom_density_2d(color = '#E69F00'))\n",
                                "}\n",
                                sep = "")
             TMM_D2_P4 <- paste(TMM_D2_P4, "```\n\n", sep = "")
             }
           }
           coinertia_text <- ""
           procrustes_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             coinertia_text <- paste(coinertia_text, "### Co-inertia colored by ", colnames(datasets[["sampleAnnot"]])[col], "\n\n",sep ="" )
             coinertia_text <- paste(coinertia_text, "```{r, warning=FALSE, comment=FALSE, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15}\n",
                                     paste("conditionCol <- \"", colnames(datasets[["sampleAnnot"]])[col],"\"\n", sep = ""),
                                     "vector_info1 <- c(rep(sampleAnnot[,conditionCol], 2))\n",
                                     "sample_info_mcoia <- data.frame(as.data.frame(mcoia[[\"mcoa\"]]$Tl1), as.data.frame(vector_info1))\n",
                                     "sample_info_mcoia_df1 <-sample_info_mcoia[1:(nrow(sample_info_mcoia)/2),]\n",
                                     "sample_info_mcoia_df2 <-sample_info_mcoia[(nrow(sample_info_mcoia)/2+1):(nrow(sample_info_mcoia)),]\n",
                                     "sample_info_mcoia_all <- data.frame(sample_info_mcoia_df1, sample_info_mcoia_df2)\n",
                                     "axis1_drivers <- data.frame(Variables_PosX = character(), Variables_PosY = character())\n",
                                     "for (i in 1:nrow(mcoia[[\"mcoa\"]]$Tco)){\n",
                                     "   if (mcoia[[\"mcoa\"]]$Tco$SV1[i] < quantile(mcoia[[\"mcoa\"]]$Tco$SV1, 0.01)){\n",
                                     "      axis1_drivers <- rbind(axis1_drivers, mcoia[[\"mcoa\"]]$Tco[i,])\n",
                                     "    }\n",
                                     "   if (mcoia[[\"mcoa\"]]$Tco$SV1[i] > quantile(mcoia[[\"mcoa\"]]$Tco$SV1, 0.99)){\n",
                                     "      axis1_drivers <- rbind(axis1_drivers, mcoia[[\"mcoa\"]]$Tco[i,])\n",
                                     "    }\n",
                                     "  }\n",
                                     "feature_type_axis1 <- c()\n",
                                     "  # If taxa file <- change OTUs sequence to family name\n",
                                     "taxon_interest_axis1 <- data.frame(taxTable[which(taxTable[[\"rn\"]] %in% rownames(axis1_drivers)),])\n",
                                     "    j <- 1\n",
                                     "for (i in 1:nrow(axis1_drivers)){\n",
                                     "  if (rownames(axis1_drivers)[i] %in% (colnames(exprDat))){\n",
                                     "    feature_type_axis1 <- c(feature_type_axis1, \"OTUs\")\n",
                                     "    axis1_drivers$Spec[i] <- taxon_interest_axis1[[\"Family\"]][j]\n",
                                     "    j <- j + 1\n",
                                     "   }else{\n",
                                     "      axis1_drivers$Spec[i] <- rownames(axis1_drivers)[i]\n",
                                     "      feature_type_axis1 <- c(feature_type_axis1, \"metabolites\")\n",
                                     " }\n",
                                     "}\n",
                                     "  axis1_drivers$feature_type_axis1 <- feature_type_axis1\n",
                                     "distance_coia.v <- c()\n",
                                     "for (i in 1:nrow(sample_info_mcoia_all)){\n",
                                     "  # Calculate distance between two point in co-inertia\n",
                                     "   dist_coia <- sqrt((sample_info_mcoia_all[i, 4] - sample_info_mcoia_all[i, 1])^2 + (sample_info_mcoia_all[i, 5] - sample_info_mcoia_all[i, 2])^2)\n",
                                     "    distance_coia.v <- c(distance_coia.v, dist_coia)\n",
                                     "  }\n",
                                     "distance_mcoia.df <- data.frame(distance_coia.v)\n",
                                     "rownames(distance_mcoia.df) <- rownames(sampleAnnot)\n", 
                                     "distance_mcoia.df$sampleName <- rownames(sampleAnnot)\n",
                                     "distTree_coia <- hclust(dist(distance_mcoia.df), method = \"average\")\n",
                                     "distance_mcoia_df_supp_info <- distance_mcoia.df\n",
                                     "distance_mcoia_df_supp_info$color <- sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col],"\"]\n",
                                     "distance_mcoia_df_supp_info <- distance_mcoia_df_supp_info[order(distance_mcoia_df_supp_info$distance_coia.v),]\n",
                                     "distance_mcoia_df_supp_info$sampleName <- as.character(distance_mcoia_df_supp_info$sampleName)\n",
                                     "distance_mcoia_df_supp_info$sampleName <- factor(distance_mcoia_df_supp_info$sampleName, levels= unique(distance_mcoia_df_supp_info$sampleName))\n",
                                     "bivariate_plot <- data.frame(mcoia[[\"mcoa\"]]$Tl1[1:(nrow(sample_info_mcoia)/2), 1], mcoia[[\"mcoa\"]]$Tl1[(nrow(sample_info_mcoia)/2+1):(nrow(sample_info_mcoia)), 1])\n",
                                     "colnames(bivariate_plot) <- c(\"Coinertia_OTUs_axis\", \"Coinertia_Metabolite_axis\")\n",
                                     "bivariate_plot$sampleName <- rownames(sampleAnnot)\n",
                                     "RV_score <- mcoia[[\"mcoa\"]]$RV[1,2]\n",
                                     "print(\"RV-Score:\", RV_score)\n",
                                     
                                     
                                     "  print(ggplot(data = sample_info_mcoia_all) +\n",
                                     "  geom_point(aes_string(x = colnames(sample_info_mcoia_all)[1], y = colnames(sample_info_mcoia_all)[2], col = colnames(sample_info_mcoia_all)[3]), size = 3) +\n",
                                     "  geom_point(aes_string(x = colnames(sample_info_mcoia_all)[4], y = colnames(sample_info_mcoia_all)[5], col = colnames(sample_info_mcoia_all)[3]), shape = 5, size = 3) +\n",
                                     "  scale_shape(solid = TRUE) +\n",
                                     "  geom_segment(aes_string(x = colnames(sample_info_mcoia_all)[1], y = colnames(sample_info_mcoia_all)[2], colour = colnames(sample_info_mcoia_all)[3], xend = colnames(sample_info_mcoia_all)[4], yend = colnames(sample_info_mcoia_all)[5])) +\n",
                                     "  geom_label_repel(data = axis1_drivers,\n",
                                     "                   aes(x = 0.10 * SV1, y = 0.10 * SV2, label = Spec, fill = feature_type_axis1),\n",
                                     "                   size = 4, segment.size = 0.5,\n",
                                     "                   label.padding = unit(0.1, \"lines\"), label.size = 0.5) +\n",
                                     "  labs(x = sprintf(\"Axis1 [%s%% Variance]\",\n",
                                     "                   100 * round(mcoia[[\"mcoa\"]]$pseudoeig[1] / sum(mcoia[[\"mcoa\"]]$pseudoeig), 2)),\n",
                                     "       y = sprintf(\"Axis2 [%s%% Variance]\",\n",
                                     "                   100 * round(mcoia[[\"mcoa\"]]$pseudoeig[2] / sum(mcoia[[\"mcoa\"]]$pseudoeig), 2))))\n",
                                     "print(ggplot(data = bivariate_plot,\n",
                                     "             aes_string(x = colnames(bivariate_plot)[1],\n",
                                     "                        y = colnames(bivariate_plot)[2],\n",
                                     "                        label = \"sampleName\")) +\n",
                                     "        geom_point() +\n",
                                     "        geom_abline(intercept = 0, slope = 1, col = \"red\") +\n",
                                     "        geom_vline(xintercept = 0) +\n",
                                     "        geom_hline(yintercept = 0) +\n",
                                     "        geom_text(vjust = 0, nudge_y = 0.02) +\n",
                                     "        annotate(\"text\", label = \"maximal correlation\", x = -0.5, y =-0.5, color = \"red\", size = 5))\n",
                                     "print(ggdendrogram(distTree_coia))\n",
                                     "print(ggplot(data = distance_mcoia_df_supp_info, aes(x= sampleName, y = distance_coia.v, col = color)) + \n",
                                     "  geom_point() + \n",
                                     "  theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
                                     "print(ggplot(distance_mcoia_df_supp_info, aes(distance_coia.v, fill = color)) + geom_histogram(binwidth = 0.1))\n",
                                     
                                     "```\n\n",
                                     
                                     sep= "")
             procrustes_text <- paste(procrustes_text, "### Procrustes by ", colnames(datasets[["sampleAnnot"]])[col], "\n\n",sep ="")
             procrustes_text <- paste(procrustes_text, "```{r, warning=FALSE, comment=FALSE, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15}\n",
                                      "if (list_input[['loadExample']] == 'Yes' || list_input[['typeData_D1']] == \"OTUs\"){\n",
                                      "  exprDat_dist <- vegdist(exprDat, method = \"euclidean\")\n",
                                      "  dudi_exprDat <- dudi.pco(exprDat_dist, scannf = FALSE, nf = 2 )\n",
                                      " }else{\n",
                                      "  exprDat_dist <- vegdist(exprDat, method = \"euclidean\")\n",
                                      "  dudi_exprDat <- dudi.pca(exprDat, scannf = FALSE, nf = 2 )\n",
                                      "}\n",
                                      "if (list_input[['loadExample']] == 'Yes' || list_input[['typeData_D2']] != \"OTUs\"){\n",
                                      "   exprDatSec_dist <- vegdist(exprDatSec, method = \"euclidean\")\n",
                                      "   dudi_exprDatSec <- dudi.pca(exprDatSec, scannf = FALSE, nf = 2 )\n",
                                      "}else{\n",
                                      "  exprDatSec_dist <- vegdist(exprDatSec, method = \"euclidean\")\n",
                                      "  dudi_exprDatSec <- dudi.pco(exprDatSec_dist, scannf = FALSE, nf = 2 )\n",
                                      "}\n",
                                      "PA_object <- procrustes(dudi_exprDat, dudi_exprDatSec, scale = TRUE)\n",
                                      
                                      "sample_info_X_PA <- data.frame(PA_object[[\"X\"]], sampleAnnot)\n",
                                      "colnames(sample_info_X_PA) <- c(\"Axis1\", \"Axis2\", colnames(sampleAnnot))\n",
                                      "sample_info_Y_PA <- data.frame(PA_object[[\"Yrot\"]], sampleAnnot)\n",
                                      "colnames(sample_info_Y_PA) <- c(\"Axis.1\", \"Axis.2\", colnames(sampleAnnot))\n",
                                      "sample_info_PA <- data.frame(sample_info_X_PA, sample_info_Y_PA)\n",
                                      
                                      "print(ggplot(data = sample_info_PA) + geom_point(aes_string(x = 'Axis1', y= 'Axis2', col ='",colnames(datasets[["sampleAnnot"]])[col] ,"'), size = 3) +\n",
                                      "  geom_point(aes_string(x = 'Axis.1', y= 'Axis.2', col = '",colnames(datasets[["sampleAnnot"]])[col] ,"'), size = 3, shape = 5) +\n",
                                      "  geom_segment(aes_string(x = 'Axis1', y = 'Axis2', xend = 'Axis.1', yend = 'Axis.2', colour = '",colnames(datasets[["sampleAnnot"]])[col] ,"')))\n",
                                      
                                      "```\n\n",
                                      sep= "")
             
             
             
           }
           
         },
         "MT"={
           numberOfFile <-4
           text_FileDescription <- paste("For this analysis 4 files were imported: a counting table, a taxonomic annotation table describing the OTUs of the counting table, a second counting table and an annotation table")
           Rel_Ab_P2 <- "## Relative Abundance (First dataset) {.tabset .tabset-fade .tabset-pills} \n"
           Rel_Ab_P2_inside_tabSet <- ""
           for (col in 1:ncol(datasets[["taxaTable"]])){
             Rel_Ab_P2_inside_tabSet <- paste(Rel_Ab_P2_inside_tabSet,
               "\n### ", colnames(datasets[["taxaTable"]])[col],"\n\n",
               "```{r, echo = FALSE, message= FALSE, warning=FALSE, comment=FALSE, fig.height= 15, fig.width = 15} \n",
               "  taxTable_relAb <- taxTable\n",
               "  taxTable_relAb$rn <- colnames(exprDat)\n", 
               "if (list_treatment[['transformation']] == \"CLR\"){\n",
               "exprDat_rel_ab <- clrInv(exprDat)\n",
               "}else{\n",
               "exprDat_rel_ab <- as.data.frame(t(apply(exprDat, 1, function(x) x / sum(x))))\n",
               "}\n",
               "  exprDat_rel_ab_setTD <- setDT(as.data.frame(t(exprDat_rel_ab)), keep.rownames = TRUE)\n",
               "  exprDat_rel_ab_setTD <- merge(exprDat_rel_ab_setTD, taxTable_relAb)\n",
               "  exprDat_Relative_abundance <- melt(exprDat_rel_ab_setTD)\n",
               
               "  ggplot(exprDat_Relative_abundance, aes_string(x = 'variable', y = 'value', fill = '",colnames(datasets[["taxaTable"]])[col],"')) +\n",
               "    geom_bar(stat = 'identity') +\n",
               "    labs(x = 'Samples', \n",
               "         y = 'Relative Abundance', \n",
               "         title = paste('Relative abundance at the ", colnames(datasets[["taxaTable"]])[col]," Taxonomic level', sep = '')) +\n",
               "    theme(axis.text.x = element_text(angle = 90, hjust = 1))\n",
               "```\n", sep = ""
             )
           }
           
           Rel_Ab_P2 <- paste(Rel_Ab_P2, Rel_Ab_P2_inside_tabSet, sep = "")
           PCoA_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text <- paste(PCoA_text, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 10, fig.width = 10}\n",
                                "ggplot(data = PCoA,\n",
                                "aes_string(x = colnames(PCoA)[1], y = colnames(PCoA)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                "geom_point(size = 2) +\n",
                                "labs(x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA$eig[1] / sum(dudi_PCoA$eig), 2)),\n",
                                "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA$eig[2] / sum(dudi_PCoA$eig), 2)))\n",
                                "```\n",
                                sep = ""
             )
           }
           PCoA_text_D2 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             PCoA_text_D2 <- paste(PCoA_text_D2, "\n### ", colnames(datasets[["sampleAnnot"]])[col],
                                   "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n",
                                   "ggplot(data = PCoA_D2,\n",
                                   "aes_string(x = colnames(PCoA_D2)[1], y = colnames(PCoA_D2)[2], col = '", colnames(datasets[["sampleAnnot"]])[col],"')) +\n",
                                   "geom_point(size = 2) +\n",
                                   "labs(x = sprintf('Axis 1 [%s%% Variance]', 100 * round(dudi_PCoA_D2$eig[1] / sum(dudi_PCoA_D2$eig), 2)),\n",
                                   "y = sprintf('Axis 2 [%s%% Variance]', 100 * round(dudi_PCoA_D2$eig[2] / sum(dudi_PCoA_D2$eig), 2)))\n",
                                   "```\n",
                                   sep = ""
             )
           }
           
           dendro_text <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text <- paste(dendro_text, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                  "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                  "ggdendrogram(dendrogramme, label = FALSE) +\n",
                                  " geom_text(data = info_dendrogramme,\n",
                                  "            aes_string(label = colnames(info_dendrogramme[3]), x = colnames(info_dendrogramme[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                  "           angle = 75,\n",
                                  "            vjust = 0,\n",
                                  "            nudge_y = -0.1,\n",
                                  "            size = 3) +\n",
                                  "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_P2']])) +\n",
                                  "  ylim(-0.15, NA)\n",
                                  "\n\n",
                                  "```\n")
           }
           
           dendro_text_D2 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             dendro_text_D2 <- paste(dendro_text_D2, "\n### Dendrogramme ", colnames(datasets[["sampleAnnot"]])[col],
                                     "\n\n```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n\n",
                                     "ggdendrogram(dendrogramme_D2, label = FALSE) +\n",
                                     " geom_text(data = info_dendrogramme_D2,\n",
                                     "            aes_string(label = colnames(info_dendrogramme_D2[3]), x = colnames(info_dendrogramme_D2[1]), y = 0, colour =\"", colnames(datasets[["sampleAnnot"]])[col], "\"),\n",
                                     "           angle = 75,\n",
                                     "            vjust = 0,\n",
                                     "            nudge_y = -0.1,\n",
                                     "            size = 3) +\n",
                                     "            labs(title=paste('Sample Dendrogramme realized with the method:', list_input[['method_dendrogramme_D2_P2']])) +\n",
                                     "  ylim(-0.15, NA)\n",
                                     "\n\n",
                                     "```\n")
           }
           
           
           Rel_Ab_P4 <- "### Relative abundance of each module {.tabset .tabset-fade .tabset-pills} \n"
           
           for (col in 1:ncol(datasets[["taxaTable"]])){
             Rel_Ab_P4 <- paste(Rel_Ab_P4, "#### Relative abundance of modules at the ", colnames(datasets[["taxaTable"]])[col], " level\n\n", sep ="")
             Rel_Ab_P4 <- paste(Rel_Ab_P4, "```{r, echo = FALSE, message = FALSE, warning=FALSE, comment=FALSE, fig.height = 15, fig.width = 15}\n",
             
             "for (module in 1:length(MEs)){\n",
             "  module_name <- substring(names(MEs)[module], 3)\n",
             "  modGenes = dynamicColors == module_name \n",
             "  selectedExpr <- exprDat[,modGenes]\n",
             "if (list_treatment[['transformation']] == \"CLR\"){\n",
             "exprDat_rel_ab <- clrInv(selectedExpr)\n",
             "}else{\n",
             "exprDat_rel_ab <- as.data.frame(t(apply(selectedExpr, 1, function(x) x / sum(x))))\n",
             "}\n",
             "  exprDat_rel_ab_setTD <- setDT(as.data.frame(t(exprDat_rel_ab)), keep.rownames = TRUE)\n",
             "  exprDat_rel_ab_setTD <- merge(exprDat_rel_ab_setTD, taxTable_relAb, by = \"rn\")\n",
             "  exprDat_rel_ab_setTD$rn <- as.character(exprDat_rel_ab_setTD$rn)\n",
             "  exprDat_rel_ab_setTD$rn <- factor(exprDat_rel_ab_setTD$rn, levels = unique(exprDat_rel_ab_setTD$rn))\n",
             "  melted_exprDat_rel_ab <- melt(exprDat_rel_ab_setTD)\n\n",
             "  if (!is.na(unique(melted_exprDat_rel_ab$", colnames(datasets[["taxaTable"]])[col], ")[1] )){\n",
             "  print(ggplot(melted_exprDat_rel_ab, aes_string(x = \"variable\", y = \"value\", fill =\"", colnames(datasets[["taxaTable"]])[col],"\")) +\n",
             "    geom_bar(stat = \"identity\") +\n",
             "    labs(x = \"Samples\", y = \"Relative Abundance\", title = paste(\"Relative abundance at the ",  colnames(datasets[["taxaTable"]])[col]," Taxonomic level of the \", module_name, \" module.\")) +\n",
             "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
             "  }else{\n",
             "    if (length(unique(melted_exprDat_rel_ab$", colnames(datasets[["taxaTable"]])[col], ") ) > 1 ){\n",
             "      print(ggplot(melted_exprDat_rel_ab, aes_string(x = \"variable\", y = \"value\", fill =\"", colnames(datasets[["taxaTable"]])[col],"\")) +\n",
             "        geom_bar(stat = \"identity\") +\n",
             "        labs(x = \"Samples\", y = \"Relative Abundance\", title = paste(\"Relative abundance at the ",  colnames(datasets[["taxaTable"]])[col]," Taxonomic level of the \", module_name, \" module.\")) +\n",
             "        theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
             "  }\n",
             "  }\n",
             "}\n",
             "```\n\n",
             sep= ""

             )
           }
           TMM_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
               TMM_P4 <- paste(TMM_P4, "\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
               TMM_P4 <- paste(TMM_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10, warning = FALSE}\n", sep = "")
               
               TMM_P4 <- paste(TMM_P4, "colnames(geneTraitSignificance) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                               "for (module in 1:length(MEs)){\n",
                               "  module_name <- substring(names(MEs)[module], 3)\n",
                               "  column = paste(\"MM\",module_name, sep = \"\")\n",
                               "  column2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                               "  moduleGenes = (dynamicColors==module_name)\n",
                               "  a <- abs(geneModuleMembership[moduleGenes, column])\n",
                               "  b <- abs(geneTraitSignificance[moduleGenes, column2])\n",
                               "  TraitModuleMembership <- data.frame(a,b)\n",
                               "  colnames(TraitModuleMembership) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                               "  pv = corPvalueStudent(cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]), method= list_input[['cor_P4']], use=\"na.or.complete\"), length(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  Correlation <- cor(abs(geneModuleMembership[moduleGenes, column]), abs(geneTraitSignificance[moduleGenes, column2]))\n",
                               "  text_trait_module_membership = paste(\"Corr = \", round(Correlation, 2), \"\nP-val = \", pv)\n",
                               
                               "   print(ggplot(TraitModuleMembership, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                               "     geom_point(color = module_name) +\n",
                               "     geom_smooth(method=lm, color = \"white\") +\n",
                               "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                               "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership ,sep = \"\")) +\n",
                               "     geom_density_2d(color = '#E69F00'))\n",
                               "}\n",
                               sep = "")
               TMM_P4 <- paste(TMM_P4, "```\n\n", sep = "")
             }
           }
           
           TMM_D2_P4 <- ""
           for (col in 1:ncol(datasets[["sampleAnnot"]])){
             if (length(unique(datasets[["sampleAnnot"]][,col])) >1){
               TMM_D2_P4 <- paste(TMM_D2_P4, "\n### Module Membership vs Trait ", colnames(datasets[["sampleAnnot"]])[col]," Significance\n\n", sep = "")
               TMM_D2_P4 <- paste(TMM_D2_P4, "```{r, echo = FALSE, message= FALSE, fig.height= 10, fig.width = 10, warning = FALSE}\n", sep = "")
               
               TMM_D2_P4 <- paste(TMM_D2_P4, "colnames(geneTraitSignificance_D2) <- paste(\"GS.\", colnames_used, sep = \"\")\n",
                                  "for (module in 1:length(MEs_D2)){\n",
                                  "  module_name <- substring(names(MEs_D2)[module], 3)\n",
                                  "  column_D2 = paste(\"MM\",module_name, sep = \"\")\n",
                                  "  column2_D2 = \"GS.", colnames(datasets[["sampleAnnot"]])[col],"\"\n",
                                  "  moduleGenes_D2 = (dynamicColors_D2==module_name)\n",
                                  "  a_D2 <- abs(geneModuleMembership_D2[moduleGenes_D2, column_D2])\n",
                                  "  b_D2 <- abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2])\n",
                                  "  TraitModuleMembership_D2 <- data.frame(a_D2,b_D2)\n",
                                  "  colnames(TraitModuleMembership_D2) <- c(\"moduleMembership\", \"TraitSignificance\")\n",
                                  "  pv_D2 = corPvalueStudent(cor(abs(geneModuleMembership_D2[moduleGenes_D2, column_D2]), abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]), method= list_input[['cor_D2_P4']], use=\"na.or.complete\"), length(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]))\n",
                                  "  Correlation_D2 <- cor(abs(geneModuleMembership_D2[moduleGenes_D2, column_D2]), abs(geneTraitSignificance_D2[moduleGenes_D2, column2_D2]))\n",
                                  "  text_trait_module_membership_D2 = paste(\"Corr = \", round(Correlation_D2, 2), \"\nP-val = \", pv_D2)\n",
                                  "   print(ggplot(TraitModuleMembership_D2, aes(x = moduleMembership, y = TraitSignificance)) +\n",
                                  "     geom_point(color = module_name) +\n",
                                  "     geom_smooth(method=lm, color = \"white\") +\n",
                                  "     labs(x = paste(\"Module Membership in\", module_name, \"module\"), y = \"OTU significance for ", colnames(datasets[["sampleAnnot"]])[col],"\",\n",
                                  "          title = paste(\"Module membership vs. gene significance\n\", text_trait_module_membership_D2 ,sep = \"\")) +\n",
                                  "     geom_density_2d(color = '#E69F00'))\n",
                                  "}\n",
                                  sep = "")
               TMM_D2_P4 <- paste(TMM_D2_P4, "```\n\n", sep = "")
             }
           }
             
             coinertia_text <- ""
             procrustes_text <- ""
             for (col in 1:ncol(datasets[["sampleAnnot"]])){
               coinertia_text <- paste(coinertia_text, "### Co-inertia colored by ", colnames(datasets[["sampleAnnot"]])[col], "\n\n",sep ="" )
               coinertia_text <- paste(coinertia_text, "```{r, warning=FALSE, comment=FALSE, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15}\n",
                                       paste("conditionCol <- \"", colnames(datasets[["sampleAnnot"]])[col],"\"\n", sep = ""),
                                       "vector_info1 <- c(rep(sampleAnnot[,conditionCol], 2))\n",
                                       "sample_info_mcoia <- data.frame(as.data.frame(mcoia[[\"mcoa\"]]$Tl1), as.data.frame(vector_info1))\n",
                                       "sample_info_mcoia_df1 <-sample_info_mcoia[1:(nrow(sample_info_mcoia)/2),]\n",
                                       "sample_info_mcoia_df2 <-sample_info_mcoia[(nrow(sample_info_mcoia)/2+1):(nrow(sample_info_mcoia)),]\n",
                                       "sample_info_mcoia_all <- data.frame(sample_info_mcoia_df1, sample_info_mcoia_df2)\n",
                                       "axis1_drivers <- data.frame(Variables_PosX = character(), Variables_PosY = character())\n",
                                       "for (i in 1:nrow(mcoia[[\"mcoa\"]]$Tco)){\n",
                                       "   if (mcoia[[\"mcoa\"]]$Tco$SV1[i] < quantile(mcoia[[\"mcoa\"]]$Tco$SV1, 0.01)){\n",
                                       "      axis1_drivers <- rbind(axis1_drivers, mcoia[[\"mcoa\"]]$Tco[i,])\n",
                                       "    }\n",
                                       "   if (mcoia[[\"mcoa\"]]$Tco$SV1[i] > quantile(mcoia[[\"mcoa\"]]$Tco$SV1, 0.99)){\n",
                                       "      axis1_drivers <- rbind(axis1_drivers, mcoia[[\"mcoa\"]]$Tco[i,])\n",
                                       "    }\n",
                                       "  }\n",
                                       "feature_type_axis1 <- c()\n",
                                       "  # If taxa file <- change OTUs sequence to family name\n",
                                       "taxon_interest_axis1 <- data.frame(taxTable[which(taxTable[[\"rn\"]] %in% rownames(axis1_drivers)),])\n",
                                       "    j <- 1\n",
                                       "for (i in 1:nrow(axis1_drivers)){\n",
                                       "  if (rownames(axis1_drivers)[i] %in% (colnames(exprDat))){\n",
                                       "    feature_type_axis1 <- c(feature_type_axis1, \"OTUs\")\n",
                                       "    axis1_drivers$Spec[i] <- taxon_interest_axis1[[\"Family\"]][j]\n",
                                       "    j <- j + 1\n",
                                       "   }else{\n",
                                       "      axis1_drivers$Spec[i] <- rownames(axis1_drivers)[i]\n",
                                       "      feature_type_axis1 <- c(feature_type_axis1, \"metabolites\")\n",
                                       " }\n",
                                       "}\n",
                                       "  axis1_drivers$feature_type_axis1 <- feature_type_axis1\n",
                                       "distance_coia.v <- c()\n",
                                       "for (i in 1:nrow(sample_info_mcoia_all)){\n",
                                       "  # Calculate distance between two point in co-inertia\n",
                                       "   dist_coia <- sqrt((sample_info_mcoia_all[i, 4] - sample_info_mcoia_all[i, 1])^2 + (sample_info_mcoia_all[i, 5] - sample_info_mcoia_all[i, 2])^2)\n",
                                       "    distance_coia.v <- c(distance_coia.v, dist_coia)\n",
                                       "  }\n",
                                       "distance_mcoia.df <- data.frame(distance_coia.v)\n",
                                       "rownames(distance_mcoia.df) <- rownames(sampleAnnot)\n", 
                                       "distance_mcoia.df$sampleName <- rownames(sampleAnnot)\n",
                                       "distTree_coia <- hclust(dist(distance_mcoia.df), method = \"average\")\n",
                                       "distance_mcoia_df_supp_info <- distance_mcoia.df\n",
                                       "distance_mcoia_df_supp_info$color <- sampleAnnot[,\"", colnames(datasets[["sampleAnnot"]])[col],"\"]\n",
                                       "distance_mcoia_df_supp_info <- distance_mcoia_df_supp_info[order(distance_mcoia_df_supp_info$distance_coia.v),]\n",
                                       "distance_mcoia_df_supp_info$sampleName <- as.character(distance_mcoia_df_supp_info$sampleName)\n",
                                       "distance_mcoia_df_supp_info$sampleName <- factor(distance_mcoia_df_supp_info$sampleName, levels= unique(distance_mcoia_df_supp_info$sampleName))\n",
                                       "bivariate_plot <- data.frame(mcoia[[\"mcoa\"]]$Tl1[1:(nrow(sample_info_mcoia)/2), 1], mcoia[[\"mcoa\"]]$Tl1[(nrow(sample_info_mcoia)/2+1):(nrow(sample_info_mcoia)), 1])\n",
                                       "colnames(bivariate_plot) <- c(\"Coinertia_OTUs_axis\", \"Coinertia_Metabolite_axis\")\n",
                                       "bivariate_plot$sampleName <- rownames(sampleAnnot)\n",
                                       "RV_score <- mcoia[[\"mcoa\"]]$RV[1,2]\n",
                                       "print(\"RV-Score:\", RV_score)\n",
                                       
                                       
                                       "  print(ggplot(data = sample_info_mcoia_all) +\n",
                                       "  geom_point(aes_string(x = colnames(sample_info_mcoia_all)[1], y = colnames(sample_info_mcoia_all)[2], col = colnames(sample_info_mcoia_all)[3]), size = 3) +\n",
                                       "  geom_point(aes_string(x = colnames(sample_info_mcoia_all)[4], y = colnames(sample_info_mcoia_all)[5], col = colnames(sample_info_mcoia_all)[3]), shape = 5, size = 3) +\n",
                                       "  scale_shape(solid = TRUE) +\n",
                                       "  geom_segment(aes_string(x = colnames(sample_info_mcoia_all)[1], y = colnames(sample_info_mcoia_all)[2], colour = colnames(sample_info_mcoia_all)[3], xend = colnames(sample_info_mcoia_all)[4], yend = colnames(sample_info_mcoia_all)[5])) +\n",
                                       "  geom_label_repel(data = axis1_drivers,\n",
                                       "                   aes(x = 0.10 * SV1, y = 0.10 * SV2, label = Spec, fill = feature_type_axis1),\n",
                                       "                   size = 4, segment.size = 0.5,\n",
                                       "                   label.padding = unit(0.1, \"lines\"), label.size = 0.5) +\n",
                                       "  labs(x = sprintf(\"Axis1 [%s%% Variance]\",\n",
                                       "                   100 * round(mcoia[[\"mcoa\"]]$pseudoeig[1] / sum(mcoia[[\"mcoa\"]]$pseudoeig), 2)),\n",
                                       "       y = sprintf(\"Axis2 [%s%% Variance]\",\n",
                                       "                   100 * round(mcoia[[\"mcoa\"]]$pseudoeig[2] / sum(mcoia[[\"mcoa\"]]$pseudoeig), 2))))\n",
                                       "print(ggplot(data = bivariate_plot,\n",
                                       "             aes_string(x = colnames(bivariate_plot)[1],\n",
                                       "                        y = colnames(bivariate_plot)[2],\n",
                                       "                        label = \"sampleName\")) +\n",
                                       "        geom_point() +\n",
                                       "        geom_abline(intercept = 0, slope = 1, col = \"red\") +\n",
                                       "        geom_vline(xintercept = 0) +\n",
                                       "        geom_hline(yintercept = 0) +\n",
                                       "        geom_text(vjust = 0, nudge_y = 0.02) +\n",
                                       "        annotate(\"text\", label = \"maximal correlation\", x = -0.5, y =-0.5, color = \"red\", size = 5))\n",
                                       "print(ggdendrogram(distTree_coia))\n",
                                       "print(ggplot(data = distance_mcoia_df_supp_info, aes(x= sampleName, y = distance_coia.v, col = color)) + \n",
                                       "  geom_point() + \n",
                                       "  theme(axis.text.x = element_text(angle = 90, hjust = 1)))\n",
                                       "print(ggplot(distance_mcoia_df_supp_info, aes(distance_coia.v, fill = color)) + geom_histogram(binwidth = 0.1))\n",
                                       
                                       "```\n\n",
                                       
                                       sep= "")
               procrustes_text <- paste(procrustes_text, "### Procrustes by ", colnames(datasets[["sampleAnnot"]])[col], "\n\n",sep ="")
               procrustes_text <- paste(procrustes_text, "```{r, warning=FALSE, comment=FALSE, echo = FALSE, message= FALSE, fig.height= 15, fig.width = 15}\n",
                                        "if (list_input[['loadExample']] == 'Yes' || list_input[['typeData_D1']] == \"OTUs\"){\n",
                                        "  exprDat_dist <- vegdist(exprDat, method = \"euclidean\")\n",
                                        "  dudi_exprDat <- dudi.pco(exprDat_dist, scannf = FALSE, nf = 2 )\n",
                                        " }else{\n",
                                        "  exprDat_dist <- vegdist(exprDat, method = \"euclidean\")\n",
                                        "  dudi_exprDat <- dudi.pca(exprDat, scannf = FALSE, nf = 2 )\n",
                                        "}\n",
                                        "if (list_input[['loadExample']] == 'Yes' || list_input[['typeData_D2']] != \"OTUs\"){\n",
                                         "   exprDatSec_dist <- vegdist(exprDatSec, method = \"euclidean\")\n",
                                        "   dudi_exprDatSec <- dudi.pca(exprDatSec, scannf = FALSE, nf = 2 )\n",
                                        "}else{\n",
                                        "  exprDatSec_dist <- vegdist(exprDatSec, method = \"euclidean\")\n",
                                        "  dudi_exprDatSec <- dudi.pco(exprDatSec_dist, scannf = FALSE, nf = 2 )\n",
                                        "}\n",
                                        "PA_object <- procrustes(dudi_exprDat, dudi_exprDatSec, scale = TRUE)\n",
                                        
                                        "sample_info_X_PA <- data.frame(PA_object[[\"X\"]], sampleAnnot)\n",
                                        "colnames(sample_info_X_PA) <- c(\"Axis1\", \"Axis2\", colnames(sampleAnnot))\n",
                                        "sample_info_Y_PA <- data.frame(PA_object[[\"Yrot\"]], sampleAnnot)\n",
                                        "colnames(sample_info_Y_PA) <- c(\"Axis.1\", \"Axis.2\", colnames(sampleAnnot))\n",
                                        "sample_info_PA <- data.frame(sample_info_X_PA, sample_info_Y_PA)\n",

                                        "print(ggplot(data = sample_info_PA) + geom_point(aes_string(x = 'Axis1', y= 'Axis2', col ='",colnames(datasets[["sampleAnnot"]])[col] ,"'), size = 3) +\n",
                                        "  geom_point(aes_string(x = 'Axis.1', y= 'Axis.2', col = '",colnames(datasets[["sampleAnnot"]])[col] ,"'), size = 3, shape = 5) +\n",
                                        "  geom_segment(aes_string(x = 'Axis1', y = 'Axis2', xend = 'Axis.1', yend = 'Axis.2', colour = '",colnames(datasets[["sampleAnnot"]])[col] ,"')))\n",
                                        
                                        "```\n\n",
                                        sep= "")
   
               
           
             }
             
            
           
           }
        
  
           )
  #### CASE ST ####
  if (vector_input[6] == "Yes" | datasets[["type"]] == "ST"){
    writeLines(c("---",
                 "title: Report MicroSysMics",
                 "output: ",
                 "  html_document:",
                 "   toc: true",
                 "   theme: united",
                 "params:",
                 " list_treatment: NA",
                 " list_input: NA",
                 " exprDat: NA",
                 " sampleAnnot: NA",
                 " taxTable: NA",
                 "---\n",
                 
                 "```{r, echo = FALSE, message = FALSE}",
                 "#define MAX_NUM_DLLS 10000",
                 "library('flexdashboard')",
                 "library('shiny')",
                 "library('shinythemes')",
                 "library('WGCNA')",
                 "library('ggplot2')",
                 "library('ggdendro')",
                 "library('ggrepel')",
                 "library('dendextend')",
                 "library('pheatmap')",
                 "library('reshape2')",
                 "library('gridExtra')",
                 "library('RColorBrewer')",
                 "library('dynamicTreeCut')",
                 "library('omicade4')",
                 "library('ade4')",
                 "library('data.table')",
                 "library('vegan')",
                 "library('gridExtra')",
                 "library('tools')",
                 "library('DT')",
                 "library('plotly')",
                 "library('iheatmapr')",
                 "library('threejs')",
                 "library('shinyjs')",
                 "library('cowplot')",
                 "library('igraph')",
                 "library('visNetwork')",
                 "library('compositions')",
                 
                 
                 "'%!in%' <- function(x,y)!('%in%'(x,y))",
                 "euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))",
                 "normalize <- function(x) {",
                 "  return ((x - min(x)) / (max(x) - min(x)))",
                 "}",
                 
                 "```",
                 
                 "# Data Import and Treatment:",
                 text_FileDescription,
                 vector_input[1],
                 vector_input[2],
                 vector_input[3],
                 "A look at the counting table:",
                 "```{r, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}",
                 "exprDat <- params$exprDat",
                 "sampleAnnot <- params$sampleAnnot",
                 "list_treatment <- params$list_treatment",
                 "list_input <- params$list_input",
                 "taxTable <- params$taxTable",
                 
                 "```",
                 paste("The following samples were removed from the analysis:", vector_input[4], "\n \n"),
                 paste(vector_input[5], "\n \n"),
                
                  #----------------------------------------------------------------------------------------------------------------------------------------------------------------              
                 
                 "# Data Overview",
                 "```{r, echo = FALSE, message = FALSE, fig.height = 15, fig.width = 15, include = FALSE}",
                 "dendrogramme = hclust(dist(exprDat), method = list_input[['method_dendrogramme_P2']])",
                 "\n",
                 "ddata_dendro <- dendro_data(dendrogramme)",
                 "labs <- label(ddata_dendro)",
                 "Samples = labs$label",
                 "conditionRow = match(Samples, rownames(sampleAnnot))",
                 "dataCondition = sampleAnnot[conditionRow, ]",
                 "labs <- data.frame(labs, dataCondition)",
                 "colnames(labs) <- c('x', 'y', 'label', colnames(dataCondition))",
                 "info_dendrogramme <- labs",
                 "\n",
                 "```\n\n",

                 "## Sample Dendrogramme (Fist dataset) {.tabset .tabset-fade .tabset-pills}",
                 "A sample dendrogramme colored according to the metadata",

                 dendro_text,


                 "\n",

                 "```{r, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}",
                 "list_Ordination <- list_input[['dist_PCoA_P2']]",
                 "if (list_Ordination[[1]] == 'PCA'){",
                 "dudi_PCoA <- dudi.pca(exprDat, scannf = FALSE, nf = 2)",
                 "}else{",
                 "D1_dist <- vegdist(exprDat, method = list_Ordination[[2]])",
                 "dudi_PCoA <- dudi.pco(D1_dist, scannf = FALSE, nf = 2)",
                 "}",
                 "PCoA <- data.frame(dudi_PCoA$li[,1:2], sampleAnnot)",
                 "```",

                 "## Ordination (First Dataset) {.tabset .tabset-fade .tabset-pills}",
                 "A PCoA representing the variability of the first dataset",
                 PCoA_text,


                 Rel_Ab_P2,

                 paste(vector_input[8], "\n \n"),
   
   #------------------------------------------------------------------------------------------------------------------------------------------------------------
   "# Section 3: Network Creation",
   "In this section, a correlation network is realized based on the WGCNA method. A set of parameters was selected for this analysis:\n",
   paste("1) A soft power of", vector_input[9], "was chosen for the network inference (for the first dataset). The soft power parameter is part of the thresholding step"),
   "and helps in the determination of the network topology.\n",
   paste("2) The minimal module size also shapes the network topology. A size of",vector_input[10],"was chosen (for the first dataset). Its determination depends on the nature of the data, the initial question raised by "),
   "the experiment. Small module sizes are chosen when the user is looking for small communities or small pathways with a few number of genes. Large",
   "module size are used when only general trends of correlation, large shifts in the expression need to be highlighted.\n",
   paste("3) A", vector_input[11], "was chosen for the analysis (for the first dataset). In signed network, the sign of the relationship between two variables is taken into"),
   "account, while in unsigned network only the strength of the relationship is considered.\n",
   paste("4) The", vector_input[13], "correlation was used in the analysis to infer the network (for the first dataset). The correlation will influence the type of relationship"),
   "observed between two variables in the network. For example, a network realized with the pearson correlation will only account for the linear relationship\n \n",

   
   "## First Dataset: \n\n",
   "```{r, echo = FALSE, message = FALSE, include = FALSE}",
   "if (nrow(exprDat) > 14){",
   "  gsg = goodSamplesGenes(exprDat, verbose = 3)",
   "   if (!gsg$allOK){",
   "      exprDat <- exprDat[rownames(exprDat)[gsg$goodSamples], colnames(exprDat)[gsg$goodGenes]]",
   "   }else{",
   "     exprDat <- exprDat",
   "   }",
   "}",
   "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
   "# Call the network topology analysis function",
   "sft <- pickSoftThreshold(exprDat, powerVector = powers, verbose = 5, networkType = list_input[['signed']])",
   "softPower <- as.numeric(list_input[['power']])",
   "if (list_input[['cor_P3']] == 'bicor'){",
   "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
   "}else{",
   "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corOptions = paste(\"method ='\", list_input[['cor_P3']], \"'\", sep = \"\")) ",
   "}",
   "TOM = TOMsimilarity(adjacency, TOMType = list_input[['signed']])",
   "dissTOM <- 1-TOM",
   "cmd1 <- cmdscale(as.dist(dissTOM),3)",
   "geneTree <- hclust(as.dist(dissTOM), method = 'average')",
   "minModuleSize = list_input[['moduleSize']]",
   "dynamicMods <- cutreeDynamic(dendro = geneTree, distM = dissTOM,",
   "                        deepSplit = 2, pamRespectsDendro = FALSE,",
   "                        minClusterSize = minModuleSize)",
   "dynamicColors = labels2colors(dynamicMods)",
   "MEList = moduleEigengenes(exprDat, colors = dynamicColors, excludeGrey = TRUE)",
   "MEs = MEList$eigengenes",
   "MEDiss = 1-cor(MEs)",
   "if (ncol(MEs) > 1){",
   "  METree = hclust(as.dist(MEDiss), method = \"average\") ",
   "}",
   "```\n \n",
   
   "### Scale Free Topology and Soft Power: \n",
   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
   "ggplot(data =sft$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
   "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
   "  geom_hline(yintercept = 0.9) +",
   "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
   "  theme(legend.position = \"none\")",
   "``` \n \n",
   
   "### Clustering of module eigengenes and Module Information \n",
   " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
   " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
   " and to compare these associations to an external traits.\n\n",
   " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
   "if (ncol(MEs) > 1){", 
   "  ggdendrogram(METree) + ",
   "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
   "}",
   "```\n\n",
   
   "```{r, echo = FALSE, message = FALSE}",
   "datatable(as.data.frame(table(dynamicColors)),",
   " class = 'cell-border stripe',",
   " rownames = FALSE, ",
   " options = list(pageLength = 8, dom = 'tip'),",
   " colnames = c('Module Color' = 'dynamicColors', 'Number of element' = 'Freq'))",
   "```\n\n",
   
   "### Variables Dendrogramme with module colors\n",
   " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
   " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
   " to ease the exploration and the description of these groups of variables.\n",
   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15}",
   "plotDendroAndColors(geneTree, dynamicColors, \"Dynamic Tree Cut\",",
   "            dendroLabels = FALSE, hang = 0.03,",
   "            addGuide = TRUE, guideHang = 0.05,",
   "            main = \"Gene dendrogram and module colors\")",
   "```\n\n",
   
   paste(vector_input[15], "\n \n"),
   #-------------------------------------------------------------------------------------------------------------------------------------------------------
   "# Section 4: Module exploration\n\n",
   "```{r, echo = FALSE, message = FALSE, include = FALSE}",
   "taxTable_rn <- setDT(taxTable, keep.rownames = TRUE)",
   "```\n",
   "## Modules correlation to external traits\n",
   "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
   " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
   "```{r, echo = FALSE, message = FALSE, fig.height = 30, fig.width = 30, warning = FALSE}",
   "nSamples <- nrow(exprDat)",
   "text_matrix_vector <- c()",
   "for (condition in 1:(ncol(sampleAnnot))){",
   "  condition_name <- colnames(sampleAnnot)[condition]",
   "  if (is.numeric(sampleAnnot[,condition_name])){",
   "      moduleTraitCor = cor(MEs, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
   "  }else{",
   "      sampleAnnot2 <- sampleAnnot",
   "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
   "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
   "      moduleTraitCor = cor(MEs, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
   "  }",
   "  moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)",
   "  colnames(moduleTraitCor) <- c(condition_name)",
   "  # Will display correlations and their p-values",
   "  textMatrix = paste(signif(moduleTraitCor, 2), \"\n(\",",
   "        signif(moduleTraitPvalue, 1), \")\", sep = \"\")",
   "  text_matrix_vector <- c(text_matrix_vector, textMatrix)",
   "  dim(textMatrix) = dim(moduleTraitCor)",

   "  # create dataframe containing the correlation and the color",
   "  if(condition == 1){",
   "    Condition_df <- data.frame(moduleTraitCor)",
   "  }else{",
   "     Condition_df <- data.frame(Condition_df, moduleTraitCor)",
   "  }",
   "  melted_moduleTraitCor <- melt(moduleTraitCor)",
   "  melted_moduleTraitCor <- data.frame(melted_moduleTraitCor, as.data.frame(substr(names(MEs), 3, 40)))",
   "  colnames(melted_moduleTraitCor)[4] <- \"color\"",
   "}",
   "Condition_df <- setDT(Condition_df, keep.rownames = TRUE)[]",
   "melted_condition_df <- melt(Condition_df, id = 1)",
   "melted_condition_df$label <- as.data.frame(text_matrix_vector)",

   "print(ggplot(data = melted_condition_df, aes(x = rn, y = variable, fill = value)) + ",
   "     geom_tile(color = \"white\") +",
   "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
   "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
   "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
   "     theme_minimal() +",
   "     theme(axis.text.x = element_text(angle = 45, vjust = 1,",
   "                                      size = 10, hjust = 1))+",
   "     geom_text(aes(label = label), color = \"black\", size = 3) +",
   "     coord_fixed() +",
   "     xlab('Module') +",
   "     ylab(''))",
   "```\n\n",

   "## Samples contribution to the module eigengenes\n",
   "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
   " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
   " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
   " module and these samples are representative of one specific condition in the dataset.\n\n",
   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
   "MEs1 <- data.frame(MEs, rownames(sampleAnnot))",

   "colnames(MEs1) <- c(colnames(MEs), \"sampleName\")",
   "for (module in 1:length(MEs)){",
   "  module_name <- substring(names(MEs)[module], 3)\n",
   "  MODS <- paste(\"ME\", module_name, sep = \"\")",
   "  print(ggplot(data = MEs1, aes_string(x = \"sampleName\", y = MODS )) +",
   "    geom_bar(stat = \"identity\", fill = module_name) +",
   "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
   "}",
   "```\n\n",


   "```{r, echo = FALSE, message = FALSE, include = FALSE}\n",
   "modNames = substring(names(MEs), 3)",
   "geneModuleMembership = as.data.frame(cor(exprDat, MEs, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
   "names(geneModuleMembership) = paste(\"MM\", modNames, sep=\"\")",
   "colnames_used <- c()",
   "for (i in names(sampleAnnot)) {",
   "  if(length(unique(sampleAnnot[,i])) > 1){",
   "    if (is.numeric(sampleAnnot[,i])){",
   "      env = as.data.frame(sampleAnnot[,i]) ",
   "    }else{",
   "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
   "    }",
   "    colnames(env) = i",
   "    colnames_used <- c(colnames_used, i)",
   "    if (i == colnames(sampleAnnot)[1]){",
   "      geneTraitSignificance = as.data.frame(cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
   "    }else{",
   "      geneTraitSignificance = data.frame(geneTraitSignificance, cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
   "    }",
   "  }",
   "}",
   "geneModuleMembership[rowSums(is.na(geneModuleMembership)) != ncol(geneModuleMembership), ] # Remove rows containing only NAs values",
   "geneTraitSignificance[rowSums(is.na(geneTraitSignificance)) != ncol(geneTraitSignificance), ]",
   "```\n\n",

   "## Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n\n",


   TMM_P4,
   Rel_Ab_P4,
   
   #### HIVE PLOTS AND PLS ####
   "## HIVE PLOTS AND PLS (per traits) {.tabset .tabset-fade .tabset-pills} \n\n",
   HIVE_PLOT,
   

   

   
   
   "## Comment on the last section \n",
   paste("\n\n", vector_input[16], "\n \n")
                 
                 
                ),
               fichier)
  }else{
    #### CASE MT ####
    if (vector_input[7] == "Yes" | datasets[["type"]] == "MT"){
      writeLines(c("---",
                   "title: Report MicroSysMics",
                   "output: ",
                   "  html_document:",
                   "   toc: true",
                   "   theme: united",
                   "params:",
                   " n: NA",
                   " list_treatment: NA",
                   " list_input: NA",
                   " exprDat: NA",
                   " sampleAnnot: NA",
                   " taxTable: NA",
                   " exprDatSec: NA",
                   "---\n",
                   
                   "```{r, echo = FALSE}",
                   "#define MAX_NUM_DLLS 10000",
                   "library('flexdashboard')",
                   "library('shiny')",
                   "library('shinythemes')",
                   "library('WGCNA')",
                   "library('ggplot2')",
                   "library('ggdendro')",
                   "library('ggrepel')",
                   "library('dendextend')",
                   "library('pheatmap')",
                   "library('reshape2')",
                   "library('gridExtra')",
                   "library('RColorBrewer')",
                   "library('dynamicTreeCut')",
                   "library('omicade4')",
                   "library('ade4')",
                   "library('data.table')",
                   "library('vegan')",
                   "library('gridExtra')",
                   "library('tools')",
                   "library('DT')",
                   "library('plotly')",
                   "library('iheatmapr')",
                   "library('threejs')",
                   "library('shinyjs')",
                   "library('cowplot')",
                   "library('igraph')",
                   "library('visNetwork')",
                   "library('compositions')",
                   
                   
                   "'%!in%' <- function(x,y)!('%in%'(x,y))",
                   "euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))",
                   "normalize <- function(x) {",
                   "  return ((x - min(x)) / (max(x) - min(x)))",
                   "}",
                   
                   "```",
                   
                   "# Data Import and Treatment:",
                   text_FileDescription,
                   vector_input[1],
                   vector_input[2],
                   vector_input[3],
                   
                   "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                   "exprDat <- params$exprDat",
                   "sampleAnnot <- params$sampleAnnot",
                   "exprDatSec <- params$exprDatSec",
                   "list_treatment <- params$list_treatment",
                   "list_input <- params$list_input",
                   "taxTable <- params$taxTable",
                  
                   "```",
                   
                   "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                   "# Data treament for the second dataset",
                   "exprDatSec[is.na(exprDatSec)] <- 0",
                   "```",
                   
                   paste("The following samples were removed from the analysis:", vector_input[4], "\n \n"),
                   paste(vector_input[5], "\n \n"),
                   
                   #----------------------------------------------------------------------------------------------------------------------------------------------------        
                   "# Data Overview",
                   "```{r, echo = FALSE, message = FALSE, fig.height = 15, fig.width = 15, include = FALSE}",
                   "dendrogramme = hclust(dist(exprDat), method = list_input[['method_dendrogramme_P2']])",
                   "\n",
                   "ddata_dendro <- dendro_data(dendrogramme)",
                   "labs <- label(ddata_dendro)",
                   "Samples = labs$label",
                   "conditionRow = match(Samples, rownames(sampleAnnot))",
                   "dataCondition = sampleAnnot[conditionRow, ]",
                   "labs <- data.frame(labs, dataCondition)",
                   "colnames(labs) <- c('x', 'y', 'label', colnames(dataCondition))",
                   "info_dendrogramme <- labs",
                   "\n",
                   "```\n\n",
                   
                   "```{r, echo = FALSE, message = FALSE}",
                   "dendrogramme_D2 = hclust(dist(exprDatSec), method = list_input[['method_dendrogramme_D2_P2']])",
                   "\n",
                   "ddata_dendro_D2 <- dendro_data(dendrogramme_D2)",
                   "labs_D2 <- label(ddata_dendro_D2)",
                   "Samples_D2 = labs_D2$label",
                   "conditionRow_D2 = match(Samples_D2, rownames(sampleAnnot))",
                   "dataCondition_D2 = sampleAnnot[conditionRow_D2, ]",
                   "labs_D2 <- data.frame(labs_D2, dataCondition_D2)",
                   "colnames(labs_D2) <- c('x', 'y', 'label', colnames(dataCondition_D2))",
                   "info_dendrogramme_D2 <- labs_D2",
                   "\n",
                   "```\n",
                   
                   "## Sample Dendrogramme (Fist dataset) {.tabset .tabset-fade .tabset-pills}",
                   "A sample dendrogramme colored according to the metadata",
                   
                   dendro_text,
                   
                   "\n## Sample Dendrogramme (Second dataset) {.tabset .tabset-fade .tabset-pills}",
                   "A sample dendrogramme colored according to the metadata",
                   
                   dendro_text_D2,

                   
                   "\n",
                   
                   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
                   "list_Ordination <- list_input[['dist_PCoA_P2']]",
                   "if (list_Ordination[[1]] == 'PCA'){",
                   "dudi_PCoA <- dudi.pca(exprDat, scannf = FALSE, nf = 2)",
                   "}else{",
                   "D1_dist <- vegdist(exprDat, method = list_Ordination[[2]])",
                   "dudi_PCoA <- dudi.pco(D1_dist, scannf = FALSE, nf = 2)",
                   "}",
                   "PCoA <- data.frame(dudi_PCoA$li[,1:2], sampleAnnot)",
                   "```",
                   
                   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
                   "list_Ordination <- list_input[['dist_PCoA_D2_P2']]",
                   "if (list_Ordination[[1]] == 'PCA'){",
                   "dudi_PCoA_D2 <- dudi.pca(exprDatSec, scannf = FALSE, nf = 2)",
                   "}else{",
                   "D2_dist <- vegdist(exprDatSec, method = list_Ordination[[2]])",
                   "dudi_PCoA_D2 <- dudi.pco(D2_dist, scannf = FALSE, nf = 2)",
                   "}",
                   "PCoA_D2 <- data.frame(dudi_PCoA_D2$li[,1:2], sampleAnnot)",
                   "```",

                   "## Ordination (First Dataset) {.tabset .tabset-fade .tabset-pills}",
                   "A PCoA representing the variability of the first dataset",
                   PCoA_text,
                   
                   "## Ordination (Second Dataset) {.tabset .tabset-fade .tabset-pills}",
                   "A PCoA representing the variability of the second dataset",
                   PCoA_text_D2,
          
                   
                   Rel_Ab_P2,
                   paste(vector_input[8], "\n \n"),
                    #------------------------------------------------------------------------------------------------------------------------------------------------------------
                   "# Section 3: Network Creation {.tabset .tabset-fade .tabset-pills}",
                   "In this section, a correlation network is realized based on the WGCNA method. A set of parameters was selected for this analysis:\n",
                   paste("1) A soft power of", vector_input[9], "was chosen for the network inference (for the first dataset). The soft power parameter is part of the thresholding step"),
                   "and helps in the determination of the network topology.\n",
                   paste("2) The minimal module size also shapes the network topology. A size of",vector_input[11],"was chosen (for the first dataset). Its determination depends on the nature of the data, the initial question raised by "),
                   "the experiment. Small module sizes are chosen when the user is looking for small communities or small pathways with a few number of genes. Large",
                   "module size are used when only general trends of correlation, large shifts in the expression need to be highlighted.\n",
                   paste("3) A", vector_input[13], "was chosen for the analysis (for the first dataset). In signed network, the sign of the relationship between two variables is taken into"),
                   "account, while in unsigned network only the strength of the relationship is considered.\n",
                   paste("4) The", vector_input[15], "correlation was used in the analysis to infer the network (for the first dataset). The correlation will influence the type of relationship"),
                   "observed between two variables in the network. For example, a network realized with the pearson correlation will only account for the linear relationship\n \n",
                   "For the second dataset: \n",
                    paste("-Soft Power:", vector_input[10], "\n"),
                    paste("- Minimum Module Size:", vector_input[12], "\n"),
                    paste("-", vector_input[14], "\n"),
                    paste("- Correlation:", vector_input[16], "\n"),

                    "## First Dataset: \n\n",
                    "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                    "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
                   "if (nrow(exprDat) > 14){",
                   "  gsg = goodSamplesGenes(exprDat, verbose = 3)",
                   "   if (!gsg$allOK){",
                   "      exprDat <- exprDat[rownames(exprDat)[gsg$goodSamples], colnames(exprDat)[gsg$goodGenes]]",
                   "   }else{",
                   "     exprDat <- exprDat",
                   "   }",
                   "}",
                    "# Call the network topology analysis function",
                    "sft <- pickSoftThreshold(exprDat, powerVector = powers, verbose = 5, networkType = list_input[['signed']])",
                    "softPower <- as.numeric(list_input[['power']])",
                    "if (list_input[['cor_P3']] == 'bicor'){",
                    "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
                    "}else{",
                    "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corOptions = paste(\"method ='\", list_input[['cor_P3']], \"'\", sep = \"\")) ",
                    "}",
                    "TOM = TOMsimilarity(adjacency, TOMType = list_input[['signed']])",
                    "dissTOM <- 1-TOM",
                    "cmd1 <- cmdscale(as.dist(dissTOM),3)",
                    "geneTree <- hclust(as.dist(dissTOM), method = 'average')",
                    "minModuleSize = list_input[['moduleSize']]",
                    "dynamicMods <- cutreeDynamic(dendro = geneTree, distM = dissTOM,",
                    "                        deepSplit = 2, pamRespectsDendro = FALSE,",
                    "                        minClusterSize = minModuleSize)",
                    "dynamicColors = labels2colors(dynamicMods)",
                    "MEList = moduleEigengenes(exprDat, colors = dynamicColors, excludeGrey = TRUE)",
                    "MEs = MEList$eigengenes",
                    "MEDiss = 1-cor(MEs)",
                    "if (ncol(MEs) > 1){",
                    "  METree = hclust(as.dist(MEDiss), method = \"average\") ",
                    "}",
                    "```\n \n",

                    "### Scale Free Topology and Soft Power: \n",
                    "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
                    "ggplot(data =sft$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
                    "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
                    "  geom_hline(yintercept = 0.9) +",
                    "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
                    "  theme(legend.position = \"none\")",
                    "``` \n \n",

                    "### Clustering of module eigengenes and Module Information \n",
                    " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
                    " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
                    " and to compare these associations to an external traits.\n\n",
                    " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
                    "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
                    "if (ncol(MEs) > 1){", 
                    "  ggdendrogram(METree) + ",
                    "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
                    "}",
                    "```\n\n",

                    "```{r, echo = FALSE, message = FALSE}",
                    "datatable(as.data.frame(table(dynamicColors)),",
                    " class = 'cell-border stripe',",
                    " rownames = FALSE, ",
                    " options = list(pageLength = 8, dom = 'tip'),",
                    " colnames = c('Module Color' = 'dynamicColors', 'Number of element' = 'Freq'))",
                    "```\n\n",

                   "### Variables Dendrogramme with module colors\n",
                   " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
                   " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
                   " to ease the exploration and the description of these groups of variables.\n",
                   "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15, , warning = FALSE}",
                   "plotDendroAndColors(geneTree, dynamicColors, \"Dynamic Tree Cut\",",
                   "            dendroLabels = FALSE, hang = 0.03,",
                   "            addGuide = TRUE, guideHang = 0.05,",
                   "            main = \"Gene dendrogram and module colors\")",
                   "```\n\n",

           "## Second Dataset: \n\n",
           "```{r, echo = FALSE, message = FALSE, include = FALSE}",
           "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
           "# Call the network topology analysis function",
           "if (nrow(exprDatSec) > 14){",
           "  gsg = goodSamplesGenes(exprDatSec, verbose = 3)",
           "   if (!gsg$allOK){",
           "      exprDatSec <- exprDatSec[rownames(exprDatSec)[gsg$goodSamples], colnames(exprDatSec)[gsg$goodGenes]]",
           "   }else{",
           "     exprDatSec <- exprDatSec",
           "   }",
           "}",
           "sft_D2 <- pickSoftThreshold(exprDatSec, powerVector = powers, verbose = 5, networkType = list_input[['signed_D2']])",
           "softPower_D2 <- as.numeric(list_input[['power_D2']])",
           "if (list_input[['cor_D2_P3']] == 'bicor'){",
           "   adjacency_D2 <- adjacency(exprDatSec, power = softPower_D2, type = list_input[['signed_D2']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
           "}else{",
           "   adjacency_D2 <- adjacency(exprDatSec, power = softPower_D2, type = list_input[['signed_D2']], corOptions = paste(\"method ='\", list_input[['cor_D2_P3']], \"'\", sep = \"\")) ",
           "}",
           "TOM_D2 = TOMsimilarity(adjacency_D2, TOMType = list_input[['signed_D2']])",
           "dissTOM_D2 <- 1-TOM_D2",
           "cmd1_D2 <- cmdscale(as.dist(dissTOM_D2),3)",
           "geneTree_D2 <- hclust(as.dist(dissTOM_D2), method = 'average')",
           "minModuleSize_D2 = list_input[['moduleSize_D2']]",
           "dynamicMods_D2 <- cutreeDynamic(dendro = geneTree_D2, distM = dissTOM_D2,",
           "                        deepSplit = 2, pamRespectsDendro = FALSE,",
           "                        minClusterSize = minModuleSize_D2)",
           "dynamicColors_D2 = labels2colors(dynamicMods_D2)",
           "MEList_D2 = moduleEigengenes(exprDatSec, colors = dynamicColors_D2, excludeGrey = TRUE)",
           "MEs_D2 = MEList_D2$eigengenes",
           "MEDiss_D2 = 1-cor(MEs_D2)",
           "if (ncol(MEs_D2) > 1){",
           "  METree_D2 = hclust(as.dist(MEDiss_D2), method = \"average\") ",
           "}",
           "```\n \n",

           "### Scale Free Topology and Soft Power: \n",
           "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
           "ggplot(data =sft_D2$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
           "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
           "  geom_hline(yintercept = 0.9) +",
           "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
           "  theme(legend.position = \"none\")",
           "``` \n \n",

           "### Clustering of module eigengenes and Module Information \n",
           " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
           " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
           " and to compare these associations to an external traits.\n\n",
           " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
           "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
           "if (ncol(MEs_D2) > 1){",
           "  ggdendrogram(METree_D2) + ",
           "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
           "}",
           "```\n\n",

           "```{r, echo = FALSE, message = FALSE}",
           "datatable(as.data.frame(table(dynamicColors_D2)),",
           " class = 'cell-border stripe',",
           " rownames = FALSE, ",
           " options = list(pageLength = 8, dom = 'tip'),",
           " colnames = c('Module Color' = 'dynamicColors_D2', 'Number of element' = 'Freq'))",
           "```\n\n",

           "### Variables Dendrogramme with module colors\n",
           " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
           " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
           " to ease the exploration and the description of these groups of variables.\n",
           "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15, warning = FALSE}",
           "plotDendroAndColors(geneTree_D2, dynamicColors_D2, \"Dynamic Tree Cut\",",
           "            dendroLabels = FALSE, hang = 0.03,",
           "            addGuide = TRUE, guideHang = 0.05,",
           "            main = \"Gene dendrogram and module colors\")",
           "```\n\n",
           paste(vector_input[17], "\n \n"),

           #-------------------------------------------------------------------------------------------------------------------------------------------------------
           "# Section 4: Module exploration\n\n",
           "## FIRST DATASET",
           "```{r, echo = FALSE, message = FALSE}",
           "taxTable_rn <- setDT(taxTable, keep.rownames = TRUE)",
           "```\n",
           "### Modules correlation to external traits\n",
           "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
           " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
           "```{r, echo = FALSE, fig.height = 30, fig.width = 30, message = FALSE, warning = FALSE}",
           "nSamples <- nrow(exprDat)",
           "text_matrix_vector <- c()",
           "for (condition in 1:(ncol(sampleAnnot))){",
           "  condition_name <- colnames(sampleAnnot)[condition]",
           "  if (is.numeric(sampleAnnot[,condition_name])){",
           "      moduleTraitCor = cor(MEs, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
           "  }else{",
           "      sampleAnnot2 <- sampleAnnot",
           "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
           "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
           "      moduleTraitCor = cor(MEs, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
           "  }",
           "  moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)",
           "  colnames(moduleTraitCor) <- c(condition_name)",
           "  # Will display correlations and their p-values",
           "  textMatrix = paste(signif(moduleTraitCor, 2), \"\n(\",",
           "        signif(moduleTraitPvalue, 1), \")\", sep = \"\")",
           "  text_matrix_vector <- c(text_matrix_vector, textMatrix)",
           "  dim(textMatrix) = dim(moduleTraitCor)",

           "  # create dataframe containing the correlation and the color",
           "  if(condition == 1){",
           "    Condition_df <- data.frame(moduleTraitCor)",
           "  }else{",
           "     Condition_df <- data.frame(Condition_df, moduleTraitCor)",
           "  }",
           "  melted_moduleTraitCor <- melt(moduleTraitCor)",
           "  melted_moduleTraitCor <- data.frame(melted_moduleTraitCor, as.data.frame(substr(names(MEs), 3, 40)))",
           "  colnames(melted_moduleTraitCor)[4] <- \"color\"",
           "}",
           "Condition_df <- setDT(Condition_df, keep.rownames = TRUE)[]",
           "melted_condition_df <- melt(Condition_df, id = 1)",
           "melted_condition_df$label <- as.data.frame(text_matrix_vector)",

           "print(ggplot(data = melted_condition_df, aes(x = rn, y = variable, fill = value)) + ",
           "     geom_tile(color = \"white\") +",
           "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
           "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
           "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
           "     theme_minimal() +",
           "     theme(axis.text.x = element_text(angle = 45, vjust = 1,",
           "                                      size = 10, hjust = 1))+",
           "     geom_text(aes(label = label), color = \"black\", size = 3) +",
           "     coord_fixed() +",
           "     xlab('Module') +",
           "     ylab(''))",
           "```\n\n",

           "### Samples contribution to the module eigengenes\n",
           "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
           " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
           " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
           " module and these samples are representative of one specific condition in the dataset.\n\n",
           "```{r, echo = FALSE}",
           "MEs1 <- data.frame(MEs, rownames(sampleAnnot))",

           "colnames(MEs1) <- c(colnames(MEs), \"sampleName\")",
           "for (module in 1:length(MEs)){",
           "  module_name <- substring(names(MEs)[module], 3)\n",
           "  MODS <- paste(\"ME\", module_name, sep = \"\")",
           "  print(ggplot(data = MEs1, aes_string(x = \"sampleName\", y = MODS )) +",
           "    geom_bar(stat = \"identity\", fill = module_name) +",
           "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
           "}",
           "```\n\n",


           "```{r, echo = FALSE, message = FALSE, include = FALSE}\n",
           "modNames = substring(names(MEs), 3)",
           "geneModuleMembership = as.data.frame(cor(exprDat, MEs, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
           "names(geneModuleMembership) = paste(\"MM\", modNames, sep=\"\")",
           "colnames_used <- c()",
           "for (i in names(sampleAnnot)) {",
           "  if(length(unique(sampleAnnot[,i])) > 1){",
           "    if (is.numeric(sampleAnnot[,i])){",
           "      env = as.data.frame(sampleAnnot[,i]) ",
           "    }else{",
           "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
           "    }",
           "    colnames(env) = i",
           "    colnames_used <- c(colnames_used, i)",
           "    if (i == colnames(sampleAnnot)[1]){",
           "      geneTraitSignificance = as.data.frame(cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
           "    }else{",
           "      geneTraitSignificance = data.frame(geneTraitSignificance, cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
           "    }",
           "  }",
           "}",
           "geneModuleMembership[rowSums(is.na(geneModuleMembership)) != ncol(geneModuleMembership), ] # Remove rows containing only NAs values",
           "geneTraitSignificance[rowSums(is.na(geneTraitSignificance)) != ncol(geneTraitSignificance), ]",
           "```\n",

           "### Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n",


           TMM_P4,
           Rel_Ab_P4,

           "## SECOND DATASET",

           "### Modules correlation to external traits\n",
           "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
           " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
           "```{r, echo = FALSE, fig.height = 15, fig.width = 15, message = FALSE, warning = FALSE}",
           "nSamples <- nrow(exprDatSec)",
           "text_matrix_vector_D2 <- c()",
           "for (condition in 1:(ncol(sampleAnnot))){",
           "  condition_name <- colnames(sampleAnnot)[condition]",
           
           "  if (is.numeric(sampleAnnot[,condition_name])){",
           "      moduleTraitCor_D2 = cor(MEs_D2, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_D2_P4']])",
           "  }else{",
           "      sampleAnnot2 <- sampleAnnot",
           "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
           "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
           "      moduleTraitCor_D2 = cor(MEs_D2, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_D2_P4']])",
           "  }",
           "  moduleTraitPvalue_D2 = corPvalueStudent(moduleTraitCor_D2, nSamples)",
           "  colnames(moduleTraitCor_D2) <- c(condition_name)",
           "  # Will display correlations and their p-values",
           "  textMatrix_D2 = paste(signif(moduleTraitCor_D2, 2), \"\n(\",",
           "        signif(moduleTraitPvalue_D2, 1), \")\", sep = \"\")",
           "  text_matrix_vector_D2 <- c(text_matrix_vector_D2, textMatrix_D2)",
           "  dim(textMatrix_D2) = dim(moduleTraitCor_D2)",

           "  # create dataframe containing the correlation and the color",
           "  if(condition == 1){",
           "    Condition_df_D2 <- data.frame(moduleTraitCor_D2)",
           "  }else{",
           "     Condition_df_D2 <- data.frame(Condition_df_D2, moduleTraitCor_D2)",
           "  }",
           "  melted_moduleTraitCor_D2 <- melt(moduleTraitCor_D2)",
           "  melted_moduleTraitCor_D2 <- data.frame(melted_moduleTraitCor_D2, as.data.frame(substr(names(MEs_D2), 3, 40)))",
           "  colnames(melted_moduleTraitCor_D2)[4] <- \"color\"",
           "}",
           "Condition_df_D2 <- setDT(Condition_df_D2, keep.rownames = TRUE)[]",
           "melted_condition_df_D2 <- melt(Condition_df_D2, id = 1)",
           "melted_condition_df_D2$label <- as.data.frame(text_matrix_vector_D2)",

           "print(ggplot(data = melted_condition_df_D2, aes(x = rn, y = variable, fill = value)) + ",
           "     geom_tile(color = \"white\") +",
           "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
           "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
           "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
           "     theme_minimal() +",
           "     theme(axis.text.x = element_text(angle = 45, vjust = 1,",
           "                                      size = 10, hjust = 1))+",
           "     geom_text(aes(label = label), color = \"black\", size = 3) +",
           "     coord_fixed() +",
           "     xlab('Module') +",
           "     ylab(''))",
           "```\n\n",

           "### Samples contribution to the module eigengenes\n",
           "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
           " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
           " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
           " module and these samples are representative of one specific condition in the dataset.\n\n",
           "```{r, , fig.width = 15, fig.heigh = 15, echo = FALSE, message = FALSE, warning = FALSE}",
           "MEs1_D2 <- data.frame(MEs_D2, rownames(sampleAnnot))",

           "colnames(MEs1_D2) <- c(colnames(MEs_D2), \"sampleName\")",
           "for (module in 1:length(MEs_D2)){",
           "  module_name <- substring(names(MEs_D2)[module], 3)\n",
           "  MODS_D2 <- paste(\"ME\", module_name, sep = \"\")",
           "  print(ggplot(data = MEs1_D2, aes_string(x = \"sampleName\", y = MODS_D2 )) +",
           "    geom_bar(stat = \"identity\", fill = module_name) +",
           "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
           "}",
           "```\n\n",


           "```{r, echo = FALSE, message = FALSE, include = FALSE}\n",
           "modNames = substring(names(MEs_D2), 3)",
           "geneModuleMembership_D2 = as.data.frame(cor(exprDatSec, MEs_D2, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
           "names(geneModuleMembership_D2) = paste(\"MM\", modNames, sep=\"\")",
           "colnames_used <- c()",
           "for (i in names(sampleAnnot)) {",
           "  if(length(unique(sampleAnnot[,i])) > 1){",
           "    if (is.numeric(sampleAnnot[,i])){",
           "      env = as.data.frame(sampleAnnot[,i]) ",
           "    }else{",
           "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
           "    }",
           "    colnames(env) = i",
           "    colnames_used <- c(colnames_used, i)",
           "    if (i == colnames(sampleAnnot)[1]){",
           "      geneTraitSignificance_D2 = as.data.frame(cor(exprDatSec, env, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
           "    }else{",
           "      geneTraitSignificance_D2 = data.frame(geneTraitSignificance_D2, cor(exprDatSec, env, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
           "    }",
           "  }",
           "}",
           "geneModuleMembership_D2[rowSums(is.na(geneModuleMembership_D2)) != ncol(geneModuleMembership_D2), ] # Remove rows containing only NAs values",
           "geneTraitSignificance_D2[rowSums(is.na(geneTraitSignificance_D2)) != ncol(geneTraitSignificance_D2), ]",
           "```\n",

           "### Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n",
          
           TMM_D2_P4,
           paste("\n\n", vector_input[18], "\n \n"),
           #----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
           "# Section 5: Multi-Omics Analysis:\n",
           "```{r, echo = FALSE, message = FALSE}\n",
           "colnames_exprDat_Unique <- c()",
           "colnames_exprDatSec_Unique <- c()",
           "for (col in 1:ncol(exprDat)){",
           " if (length(unique(exprDat[,col])) == 1){",
           "   colnames_exprDat_Unique <- c(colnames_exprDat_Unique, colnames(exprDat)[col])",
           " }",
           "}",
           "exprDat_NonUnique <- exprDat[, which(colnames(exprDat) %!in% colnames_exprDat_Unique)]",
           "for (col in 1:ncol(exprDatSec)){",
           " if (length(unique(exprDatSec[,col])) == 1){",
           "   colnames_exprDatSec_Unique <- c(colnames_exprDatSec_Unique, colnames(exprDatSec)[col])",
           " }",
           "}",
           "exprDatSec_NonUnique <- exprDatSec[, which(colnames(exprDatSec) %!in% colnames_exprDatSec_Unique)]",
           "df1_df2 <- list()",
           "df1_df2[[\"df1\"]] <- t(as.data.frame(exprDat_NonUnique))",
           "exprDatSec_NonUnique[which(is.na(exprDatSec_NonUnique)),] <- 0",
           "df1_df2[[\"df2\"]] <- t(as.data.frame(exprDatSec_NonUnique))",
           "mcoia <- mcia(df1_df2, nsc = F)",
           "```\n\n",
           "## General Co-inertia {.tabset .tabset-fade .tabset-pills}\n\n ",
           coinertia_text,
           "## General Procrustes Analysis {.tabset .tabset-fade .tabset-pills} \n\n",
           procrustes_text,

           "## Heatmap representing the correlation between the modules of each network \n\n",
           "```{r, fig.width = 15, fig.height = 20, echo = FALSE, message = FALSE}\n",
           "corr_MEs_D1D2 <- cor(MEs, MEs_D2, use = \"p\", method = \"spearman\")",
           "corr_MEs_D1D2 <- as.data.frame(corr_MEs_D1D2)",
           "row.order <- hclust(dist(corr_MEs_D1D2, method = \"euclidean\"), method = \"ward.D\")$order ",
           "col.order <- hclust(dist(t(corr_MEs_D1D2), method = \"euclidean\"), method = \"ward.D\")$order",
           "corr_MEs_D1D2 <- corr_MEs_D1D2[row.order, col.order]",
           "corr_MEs_D1D2 <- t(corr_MEs_D1D2)",

           "main_heatmap(corr_MEs_D1D2, name = \"Correlation between MEs\") %>%",
           "  add_row_labels() %>%",
           "  add_col_labels() %>%",
           "  add_col_clustering() %>%",
           "  add_row_clustering() %>%",
           "  add_col_title(\"Modules of the first dataset\") %>% ",
           "  add_row_title(\"Modules of the second dataset\") ",

           "```\n\n",

           "## Specific heatmap between modules of different networks \n",
           "In this section, correlation heatmap between the variables of the modules of each heatmap have been realized on ",
           "modules known to be highly correlated to each other. \n",

           "```{r, fig.width = 15, fig.height = 15, echo = FALSE, message = FALSE}\n",
           "for (modules in 1:ncol(corr_MEs_D1D2)){",
           "  for(modules_D2 in 1:nrow(corr_MEs_D1D2)){",
           "    if (abs(corr_MEs_D1D2[modules_D2, modules]) >= list_input['minimalCorrelation']){",
           "       module_name_D1 = substr(colnames(corr_MEs_D1D2)[modules], 3, 40)",
           "       module_name_D2 = substr(rownames(corr_MEs_D1D2)[modules_D2], 3, 40)",
           "       print(paste('Dataset 1 : Module', module_name_D1, '\n'))",
           "       print(paste('Dataset 2 : Module', module_name_D2, '\n'))",
          
           "        modGenes_D1 = (dynamicColors == module_name_D1)",
           "        modGenes_D2 = (dynamicColors_D2 == module_name_D2)",
           "        sub_exprDat <- exprDat[modGenes_D1]",
           "        sub_exprDatSec <- exprDatSec[,modGenes_D2]",
           "        corr_expr_1 <- cor(sub_exprDat, sub_exprDatSec, use = \"p\", method = \"spearman\")",
           "        corr_expr_1 <- as.data.frame(corr_expr_1)",
           "        row.order <- hclust(dist(corr_expr_1, method = \"euclidean\"), method = \"ward.D\")$order ",
           "        col.order <- hclust(dist(t(corr_expr_1), method = \"euclidean\"), method = \"ward.D\")$order",
           "        corr_expr_new <- corr_expr_1[row.order, col.order]",
           "        corr_expr_new <- t(corr_expr_new)",
           "        taxon_annotation <- taxTable_relAb[which(taxTable_relAb[[\"rn\"]] %in% colnames(corr_expr_new)),]",
           "        taxon_group <- as.vector(taxon_annotation[[colnames(taxon_annotation)[4]]])",
           "        my_group=as.numeric(as.factor(taxon_group))",
           "        my_col=brewer.pal(9, \"Set1\")[my_group]",
           "        heatmap(corr_expr_new, ColSideColors = my_col, margins = c(15,15))",

           "        legend(\"topright\", ",
           "           legend = unique(taxon_group),",
           "           col = unique(my_col), ",
           "           lty = 1,",
           "           lwd = 5,",
           "           cex=.7",
           "        )",
           "        corr_expr_1[abs(corr_expr_1) < 0.5] <- 0",
           "        corr_expr_1[abs(corr_expr_1) >= 0.5] <- 1",

           "        if (nchar(rownames(corr_expr_1)[5]) >20){",
           "          for (row in 1:nrow(corr_expr_1)){",
           "            rownames(corr_expr_1)[row] <- paste(\"OTU\", row, sep=\"\")",
           "          }",
           "        }",
           "        corr_expr_1 <- t(corr_expr_1)",
           "        bip = network(corr_expr_1,",
           "          matrix.type = \"bipartite\",",
           "          ignore.eval = FALSE,",
           "          names.eval = \"weights\")",
           "        col = c(\"actor\" = \"red\", \"event\" = \"blue\")",
           "        print(ggnet2(bip, color = \"mode\", palette = col, label = TRUE, layout.exp = 0.25, shape= \"mode\") +",
           "          theme(legend.position=\"none\")) ",
           "    }",
           "  }",
           "}",
          "```\n\n",
          vector_input[19]

    
           ),
                 fichier)
    }else{
      #### CASE S ####
      if (datasets[["type"]] == "S"){
        writeLines(c("---",
                     "title: Report MicroSysMics",
                     "output: ",
                     "  html_document:",
                     "   toc: true",
                     "   theme: united",
                     "params:",
                     " n: NA",
                     " list_treatment: NA",
                     " list_input: NA",
                     " exprDat: NA",
                     " sampleAnnot: NA",
                     "---\n",
                     "```{r, echo = FALSE}",
                     "#define MAX_NUM_DLLS 10000",
                     "library('flexdashboard')",
                     "library('shiny')",
                     "library('shinythemes')",
                     "library('WGCNA')",
                     "library('ggplot2')",
                     "library('ggdendro')",
                     "library('ggrepel')",
                     "library('dendextend')",
                     "library('pheatmap')",
                     "library('reshape2')",
                     "library('gridExtra')",
                     "library('RColorBrewer')",
                     "library('dynamicTreeCut')",
                     "library('omicade4')",
                     "library('ade4')",
                     "library('data.table')",
                     "library('vegan')",
                     "library('gridExtra')",
                     "library('tools')",
                     "library('DT')",
                     "library('plotly')",
                     "library('iheatmapr')",
                     "library('threejs')",
                     "library('shinyjs')",
                     "library('cowplot')",
                     "library('igraph')",
                     "library('visNetwork')",
                     "library('compositions')",
                     
                     
                     "'%!in%' <- function(x,y)!('%in%'(x,y))",
                     "euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))",
                     "normalize <- function(x) {",
                     "  return ((x - min(x)) / (max(x) - min(x)))",
                     "}",
                     
                     "```",
                     
                     "# Data Import and Treatment:",
                     text_FileDescription,
                     vector_input[1],
                     vector_input[2],
                     vector_input[3],
                     
                     "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                     "exprDat <- params$exprDat",
                     "sampleAnnot <- params$sampleAnnot",
                     "list_input <- params$list_input",
                     "list_treatment <- params$list_treatment",
                     "```",
                     paste("The following samples were removed from the analysis:", vector_input[4], "\n \n"),
                     paste(vector_input[5], "\n \n"),
                     #---------------------------------------------------------------------------------------------------------------------------------------               
                     
                     "# Data Overview",
                     "```{r, echo = FALSE, message = FALSE, fig.height = 15, fig.width = 15, include = FALSE}",
                     "dendrogramme = hclust(dist(exprDat), method = list_input[['method_dendrogramme_P2']])",
                     "\n",
                     "ddata_dendro <- dendro_data(dendrogramme)",
                     "labs <- label(ddata_dendro)",
                     "Samples = labs$label",
                     "conditionRow = match(Samples, rownames(sampleAnnot))",
                     "dataCondition = sampleAnnot[conditionRow, ]",
                     "labs <- data.frame(labs, dataCondition)",
                     "colnames(labs) <- c('x', 'y', 'label', colnames(dataCondition))",
                     "info_dendrogramme <- labs",
                     "\n",
                     "```\n\n",
                     
                    
                     
                     "## Sample Dendrogramme (Fist dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A sample dendrogramme colored according to the metadata",
                     
                     dendro_text,
                     
                     
                     
                     "```{r}",
                     "list_Ordination <- list_input[['dist_PCoA_P2']]",
                     "if (list_Ordination[[1]] == 'PCA'){",
                     "dudi_PCoA <- dudi.pca(exprDat, scannf = FALSE, nf = 2)",
                     "}else{",
                     "D1_dist <- vegdist(exprDat, method = list_Ordination[[2]])",
                     "dudi_PCoA <- dudi.pco(D1_dist, scannf = FALSE, nf = 2)",
                     "}",
                     "PCoA <- data.frame(dudi_PCoA$li[,1:2], sampleAnnot)",
                     "```",
                     
                     "## Ordination (First Dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A PCoA representing the variability of the first dataset",
                     PCoA_text,
                     paste(vector_input[8], "\n \n"),
      
      #------------------------------------------------------------------------------------------------------------------------------------------------------------
      "# Section 3: Network Creation",
      "In this section, a correlation network is realized based on the WGCNA method. A set of parameters was selected for this analysis:\n",
      paste("1) A soft power of", vector_input[9], "was chosen for the network inference (for the first dataset). The soft power parameter is part of the thresholding step"),
      "and helps in the determination of the network topology.\n",
      paste("2) The minimal module size also shapes the network topology. A size of",vector_input[10],"was chosen (for the first dataset). Its determination depends on the nature of the data, the initial question raised by "),
      "the experiment. Small module sizes are chosen when the user is looking for small communities or small pathways with a few number of genes. Large",
      "module size are used when only general trends of correlation, large shifts in the expression need to be highlighted.\n",
      paste("3) A", vector_input[11], "was chosen for the analysis (for the first dataset). In signed network, the sign of the relationship between two variables is taken into"),
      "account, while in unsigned network only the strength of the relationship is considered.\n",
      paste("4) The", vector_input[13], "correlation was used in the analysis to infer the network (for the first dataset). The correlation will influence the type of relationship"),
      "observed between two variables in the network. For example, a network realized with the pearson correlation will only account for the linear relationship\n \n",

      
      "## First Dataset: \n\n",
      "```{r, echo = FALSE, message = FALSE, include = FALSE}",
      "if (nrow(exprDat) > 14){",
      "  gsg = goodSamplesGenes(exprDat, verbose = 3)",
      "   if (!gsg$allOK){",
      "      exprDat <- exprDat[rownames(exprDat)[gsg$goodSamples], colnames(exprDat)[gsg$goodGenes]]",
      "   }else{",
      "     exprDat <- exprDat",
      "   }",
      "}",
      "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
      "# Call the network topology analysis function",
      "sft <- pickSoftThreshold(exprDat, powerVector = powers, verbose = 5, networkType = list_input[['signed']])",
      "softPower <- as.numeric(list_input[['power']])",
      "if (list_input[['cor_P3']] == 'bicor'){",
      "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
      "}else{",
      "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corOptions = paste(\"method ='\", list_input[['cor_P3']], \"'\", sep = \"\")) ",
      "}",
      "TOM = TOMsimilarity(adjacency, TOMType = list_input[['signed']])",
      "dissTOM <- 1-TOM",
      "cmd1 <- cmdscale(as.dist(dissTOM),3)",
      "geneTree <- hclust(as.dist(dissTOM), method = 'average')",
      "minModuleSize = list_input[['moduleSize']]",
      "dynamicMods <- cutreeDynamic(dendro = geneTree, distM = dissTOM,",
      "                        deepSplit = 2, pamRespectsDendro = FALSE,",
      "                        minClusterSize = minModuleSize)",
      "dynamicColors = labels2colors(dynamicMods)",
      "MEList = moduleEigengenes(exprDat, colors = dynamicColors, excludeGrey = TRUE)",
      "MEs = MEList$eigengenes",
      "MEDiss = 1-cor(MEs)",
      "if (ncol(MEs) > 1){",
      "  METree = hclust(as.dist(MEDiss), method = \"average\") ",
      "}",
      "```\n \n",
      
      "### Scale Free Topology and Soft Power: \n",
      "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
      "ggplot(data =sft$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
      "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
      "  geom_hline(yintercept = 0.9) +",
      "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
      "  theme(legend.position = \"none\")",
      "``` \n \n",
      
      "### Clustering of module eigengenes and Module Information \n",
      " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
      " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
      " and to compare these associations to an external traits.\n\n",
      " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
      "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
      "if (ncol(MEs) > 1){", 
      "  ggdendrogram(METree) + ",
      "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
      "}",
      "```\n\n",
      
      "```{r, echo = FALSE, message = FALSE}",
      "datatable(as.data.frame(table(dynamicColors)),",
      " class = 'cell-border stripe',",
      " rownames = FALSE, ",
      " options = list(pageLength = 8, dom = 'tip'),",
      " colnames = c('Module Color' = 'dynamicColors', 'Number of element' = 'Freq'))",
      "```\n\n",
      
      "### Variables Dendrogramme with module colors\n",
      " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
      " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
      " to ease the exploration and the description of these groups of variables.\n",
      "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15, warning = FALSE}",
      "plotDendroAndColors(geneTree, dynamicColors, \"Dynamic Tree Cut\",",
      "            dendroLabels = FALSE, hang = 0.03,",
      "            addGuide = TRUE, guideHang = 0.05,",
      "            main = \"Gene dendrogram and module colors\")",
      "```\n\n",
      paste(vector_input[15], "\n \n"),
      #-------------------------------------------------------------------------------------------------------------------------------------------------------
      "# Section 4: Module exploration\n\n",

      "## Modules correlation to external traits\n",
      "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
      " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
      "```{r, echo = FALSE, fig.height = 30, fig.width = 30, warning = FALSE, message = FALSE}",
      "nSamples <- nrow(exprDat)",
      "text_matrix_vector <- c()",
      "for (condition in 1:(ncol(sampleAnnot))){",
      "  condition_name <- colnames(sampleAnnot)[condition]",
      "  if (is.numeric(sampleAnnot[,condition_name])){",
      "      moduleTraitCor = cor(MEs, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
      "  }else{",
      "      sampleAnnot2 <- sampleAnnot",
      "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
      "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
      "      moduleTraitCor = cor(MEs, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
      "  }",
      "  moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)",
      "  colnames(moduleTraitCor) <- c(condition_name)",
      "  # Will display correlations and their p-values",
      "  textMatrix = paste(signif(moduleTraitCor, 2), \"\n(\",",
      "        signif(moduleTraitPvalue, 1), \")\", sep = \"\")",
      "  text_matrix_vector <- c(text_matrix_vector, textMatrix)",
      "  dim(textMatrix) = dim(moduleTraitCor)",
      
      "  # create dataframe containing the correlation and the color",
      "  if(condition == 1){",
      "    Condition_df <- data.frame(moduleTraitCor)",
      "  }else{",
      "     Condition_df <- data.frame(Condition_df, moduleTraitCor)",
      "  }",
      "  melted_moduleTraitCor <- melt(moduleTraitCor)",
      "  melted_moduleTraitCor <- data.frame(melted_moduleTraitCor, as.data.frame(substr(names(MEs), 3, 40)))",
      "  colnames(melted_moduleTraitCor)[4] <- \"color\"",
      "}",
      "Condition_df <- setDT(Condition_df, keep.rownames = TRUE)[]",
      "melted_condition_df <- melt(Condition_df, id = 1)",
      "melted_condition_df$label <- as.data.frame(text_matrix_vector)",
      
      "print(ggplot(data = melted_condition_df, aes(x = rn, y = variable, fill = value)) + ",
      "     geom_tile(color = \"white\") +",
      "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
      "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
      "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
      "     theme_minimal() +",
      "     theme(axis.text.x = element_text(angle = 45, vjust = 1,", 
      "                                      size = 10, hjust = 1))+",
      "     geom_text(aes(label = label), color = \"black\", size = 3) +",
      "     coord_fixed() +",
      "     xlab('Module') +",
      "     ylab(''))",
      "```\n\n",
      
      "## Samples contribution to the module eigengenes\n",
      "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
      " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
      " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
      " module and these samples are representative of one specific condition in the dataset.\n\n",
      "```{r, echo = FALSE}",
      "MEs1 <- data.frame(MEs, rownames(sampleAnnot))",
      
      "colnames(MEs1) <- c(colnames(MEs), \"sampleName\")",
      "for (module in 1:length(MEs)){",
      "  module_name <- substring(names(MEs)[module], 3)\n",
      "  MODS <- paste(\"ME\", module_name, sep = \"\")",
      "  print(ggplot(data = MEs1, aes_string(x = \"sampleName\", y = MODS )) +",
      "    geom_bar(stat = \"identity\", fill = module_name) +", 
      "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
      "}",
      "```\n\n",
      
      
      "```{r, echo = FALSE, message = FALSE, warning = FALSE, message = FALSE}\n",
      "modNames = substring(names(MEs), 3)",
      "geneModuleMembership = as.data.frame(cor(exprDat, MEs, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
      "names(geneModuleMembership) = paste(\"MM\", modNames, sep=\"\")",
      "colnames_used <- c()",
      "for (i in names(sampleAnnot)) {",
      "  if(length(unique(sampleAnnot[,i])) > 1){",
      "    if (is.numeric(sampleAnnot[,i])){",
      "      env = as.data.frame(sampleAnnot[,i]) ",
      "    }else{",
      "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
      "    }",
      "    colnames(env) = i",
      "    colnames_used <- c(colnames_used, i)",
      "    if (i == colnames(sampleAnnot)[1]){",
      "      geneTraitSignificance = as.data.frame(cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
      "    }else{",
      "      geneTraitSignificance = data.frame(geneTraitSignificance, cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
      "    }",
      "  }",
      "}",
      "geneModuleMembership[rowSums(is.na(geneModuleMembership)) != ncol(geneModuleMembership), ] # Remove rows containing only NAs values",
      "geneTraitSignificance[rowSums(is.na(geneTraitSignificance)) != ncol(geneTraitSignificance), ]",
      "```\n",
      
      "## Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n",
      
      
      TMM_P4,
      paste("\n\n", vector_input[16], "\n \n")
      ),
                   fichier)
      }else{
        #### CASE M ####
        writeLines(c("---",
                     "title: Report MicroSysMics",
                     "output: ",
                     "  html_document:",
                     "   toc: true",
                     "   theme: united",
                     "params:",
                     " n: NA",
                     " list_treatment: NA",
                     " list_input: NA",
                     " exprDat: NA",
                     " sampleAnnot: NA",
                     " exprDatSec: NA",
                     "---\n",
                     
                     "```{r, echo = FALSE}",
                     "#define MAX_NUM_DLLS 10000",
                     "library('flexdashboard')",
                     "library('shiny')",
                     "library('shinythemes')",
                     "library('WGCNA')",
                     "library('ggplot2')",
                     "library('ggdendro')",
                     "library('ggrepel')",
                     "library('dendextend')",
                     "library('pheatmap')",
                     "library('reshape2')",
                     "library('gridExtra')",
                     "library('RColorBrewer')",
                     "library('dynamicTreeCut')",
                     "library('omicade4')",
                     "library('ade4')",
                     "library('data.table')",
                     "library('vegan')",
                     "library('gridExtra')",
                     "library('tools')",
                     "library('DT')",
                     "library('plotly')",
                     "library('iheatmapr')",
                     "library('threejs')",
                     "library('shinyjs')",
                     "library('cowplot')",
                     "library('igraph')",
                     "library('visNetwork')",
                     "library('compositions')",
                     
                     
                     "'%!in%' <- function(x,y)!('%in%'(x,y))",
                     "euc.dist <- function(x1, x2) sqrt(sum((x1 - x2) ^ 2))",
                     "normalize <- function(x) {",
                     "  return ((x - min(x)) / (max(x) - min(x)))",
                     "}",
                     
                     "```",
                     
                     "# Data Import and Treatment:",
                     text_FileDescription,
                     vector_input[1],
                     vector_input[2],
                     vector_input[3],
                     "A look at the counting table:",
                     
                     "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                     "exprDat <- params$exprDat",
                     "sampleAnnot <- params$sampleAnnot",
                     "exprDatSec <- params$exprDatSec",
                     "list_input <- params$list_input",
                     "list_treatment <- params$list_treatment",
                     
                     "```",
                     
                     "```{r, echo = FALSE, message = FALSE, include = FALSE}",
                     "# Data treament for the second dataset",
                     "exprDatSec[is.na(exprDatSec)] <- 0",
                     "```",
                     
                     paste("The following samples were removed from the analysis:", vector_input[4], "\n \n"),
                     paste(vector_input[5], "\n \n"),
                     
                     #--------------------------------------------------------------------------------------------------------------------------------            
                     "# Data Overview",
                     "```{r, echo = FALSE, message = FALSE, fig.height = 15, fig.width = 15, include = FALSE}",
                     "dendrogramme = hclust(dist(exprDat), method = list_input[['method_dendrogramme_P2']])",
                     "\n",
                     "ddata_dendro <- dendro_data(dendrogramme)",
                     "labs <- label(ddata_dendro)",
                     "Samples = labs$label",
                     "conditionRow = match(Samples, rownames(sampleAnnot))",
                     "dataCondition = sampleAnnot[conditionRow, ]",
                     "labs <- data.frame(labs, dataCondition)",
                     "colnames(labs) <- c('x', 'y', 'label', colnames(dataCondition))",
                     "info_dendrogramme <- labs",
                     "\n",
                     "```\n\n",
                     
                     "```{r, echo = FALSE, message = FALSE}",
                     "dendrogramme_D2 = hclust(dist(exprDatSec), method = list_input[['method_dendrogramme_D2_P2']])",
                     "\n",
                     "ddata_dendro_D2 <- dendro_data(dendrogramme_D2)",
                     "labs_D2 <- label(ddata_dendro_D2)",
                     "Samples_D2 = labs_D2$label",
                     "conditionRow_D2 = match(Samples_D2, rownames(sampleAnnot))",
                     "dataCondition_D2 = sampleAnnot[conditionRow_D2, ]",
                     "labs_D2 <- data.frame(labs_D2, dataCondition_D2)",
                     "colnames(labs_D2) <- c('x', 'y', 'label', colnames(dataCondition_D2))",
                     "info_dendrogramme_D2 <- labs_D2",
                     "\n",
                     "```\n",
                     
                     "## Sample Dendrogramme (Fist dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A sample dendrogramme colored according to the metadata",
                     
                     dendro_text,
                     
                     "\n## Sample Dendrogramme (Second dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A sample dendrogramme colored according to the metadata",
                     
                     dendro_text_D2,
                     
                     "```{r}",
                     "list_Ordination <- list_input[['dist_PCoA_P2']]",
                     "if (list_Ordination[[1]] == 'PCA'){",
                     "dudi_PCoA <- dudi.pca(exprDat, scannf = FALSE, nf = 2)",
                     "}else{",
                     "D1_dist <- vegdist(exprDat, method = list_Ordination[[2]])",
                     "dudi_PCoA <- dudi.pco(D1_dist, scannf = FALSE, nf = 2)",
                     "}",
                     "PCoA <- data.frame(dudi_PCoA$li[,1:2], sampleAnnot)",
                     "```",
                     
                     "```{r}",
                     "list_Ordination <- list_input[['dist_PCoA_D2_P2']]",
                     "if (list_Ordination[[1]] == 'PCA'){",
                     "dudi_PCoA_D2 <- dudi.pca(exprDatSec, scannf = FALSE, nf = 2)",
                     "}else{",
                     "D2_dist <- vegdist(exprDatSec, method = list_Ordination[[2]])",
                     "dudi_PCoA_D2 <- dudi.pco(D2_dist, scannf = FALSE, nf = 2)",
                     "}",
                     "PCoA_D2 <- data.frame(dudi_PCoA_D2$li[,1:2], sampleAnnot)",
                     "```",
                     
                     "## Ordination (First Dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A PCoA representing the variability of the first dataset",
                     PCoA_text,
                     
                     "## Ordination (Second Dataset) {.tabset .tabset-fade .tabset-pills}",
                     "A PCoA representing the variability of the second dataset",
                     PCoA_text_D2,
         paste(vector_input[8], "\n \n"),
         
         #------------------------------------------------------------------------------------------------------------------------------------------------------------
         "# Section 3: Network Creation {.tabset .tabset-fade .tabset-pills}",
         "In this section, a correlation network is realized based on the WGCNA method. A set of parameters was selected for this analysis:\n",
         paste("1) A soft power of", vector_input[9], "was chosen for the network inference (for the first dataset). The soft power parameter is part of the thresholding step"),
         "and helps in the determination of the network topology.\n",
         paste("2) The minimal module size also shapes the network topology. A size of",vector_input[11],"was chosen (for the first dataset). Its determination depends on the nature of the data, the initial question raised by "),
         "the experiment. Small module sizes are chosen when the user is looking for small communities or small pathways with a few number of genes. Large",
         "module size are used when only general trends of correlation, large shifts in the expression need to be highlighted.\n",
         paste("3) A", vector_input[13], "was chosen for the analysis (for the first dataset). In signed network, the sign of the relationship between two variables is taken into"),
         "account, while in unsigned network only the strength of the relationship is considered.\n",
         paste("4) The", vector_input[15], "correlation was used in the analysis to infer the network (for the first dataset). The correlation will influence the type of relationship"),
         "observed between two variables in the network. For example, a network realized with the pearson correlation will only account for the linear relationship\n \n",
         "For the second dataset: \n",
         paste("-Soft Power:", vector_input[10], "\n"),
         paste("- Minimum Module Size:", vector_input[12], "\n"),
         paste("-", vector_input[14], "\n"),
         paste("- Correlation:", vector_input[16], "\n"),
         
         "## First Dataset: \n\n",
         "```{r, echo = FALSE, message = FALSE}",
         "if (nrow(exprDat) > 14){",
         "  gsg = goodSamplesGenes(exprDat, verbose = 3)",
         "   if (!gsg$allOK){",
         "      exprDat <- exprDat[rownames(exprDat)[gsg$goodSamples], colnames(exprDat)[gsg$goodGenes]]",
         "   }else{",
         "     exprDat <- exprDat",
         "   }",
         "}",
         "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
         "# Call the network topology analysis function",
         "sft <- pickSoftThreshold(exprDat, powerVector = powers, verbose = 5, networkType = list_input[['signed']])",
         "softPower <- as.numeric(list_input[['power']])",
         "if (list_input[['cor_P3']] == 'bicor'){",
         "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
         "}else{",
         "   adjacency <- adjacency(exprDat, power = softPower, type = list_input[['signed']], corOptions = paste(\"method ='\", list_input[['cor_P3']], \"'\", sep = \"\")) ",
         "}",
         "TOM = TOMsimilarity(adjacency, TOMType = list_input[['signed']])",
         "dissTOM <- 1-TOM",
         "cmd1 <- cmdscale(as.dist(dissTOM),3)",
         "geneTree <- hclust(as.dist(dissTOM), method = 'average')",
         "minModuleSize = list_input[['moduleSize']]",
         "dynamicMods <- cutreeDynamic(dendro = geneTree, distM = dissTOM,",
         "                        deepSplit = 2, pamRespectsDendro = FALSE,",
         "                        minClusterSize = minModuleSize)",
         "dynamicColors = labels2colors(dynamicMods)",
         "MEList = moduleEigengenes(exprDat, colors = dynamicColors, excludeGrey = TRUE)",
         "MEs = MEList$eigengenes",
         "MEDiss = 1-cor(MEs)",
         "if (ncol(MEs) > 1){",
         "  METree = hclust(as.dist(MEDiss), method = \"average\") ",
         "}",
         "```\n \n",
         
         "### Scale Free Topology and Soft Power: \n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
         "ggplot(data =sft$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
         "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
         "  geom_hline(yintercept = 0.9) +",
         "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
         "  theme(legend.position = \"none\")",
         "``` \n \n",
         
         "### Clustering of module eigengenes and Module Information \n",
         " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
         " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
         " and to compare these associations to an external traits.\n\n",
         " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
         "if (ncol(MEs) > 1){", 
         "  ggdendrogram(METree) + ",
         "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
         "}",
         "```\n\n",
         
         "```{r, echo = FALSE, message = FALSE}",
         "datatable(as.data.frame(table(dynamicColors)),",
         " class = 'cell-border stripe',",
         " rownames = FALSE, ",
         " options = list(pageLength = 8, dom = 'tip'),",
         " colnames = c('Module Color' = 'dynamicColors', 'Number of element' = 'Freq'))",
         "```\n\n",
         
         "### Variables Dendrogramme with module colors\n",
         " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
         " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
         " to ease the exploration and the description of these groups of variables.\n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15}",
         "plotDendroAndColors(geneTree, dynamicColors, \"Dynamic Tree Cut\",",
         "            dendroLabels = FALSE, hang = 0.03,",
         "            addGuide = TRUE, guideHang = 0.05,",
         "            main = \"Gene dendrogram and module colors\")",
         "```\n\n",
         
         "## Second Dataset: \n\n",
         "```{r, echo = FALSE, message = FALSE}",
         "powers = c(c(1:10), seq(from = 12, to=20, by=2))",
         "# Call the network topology analysis function",
         "if (nrow(exprDatSec) > 14){",
         "  gsg = goodSamplesGenes(exprDatSec, verbose = 3)",
         "   if (!gsg$allOK){",
         "      exprDatSec <- exprDatSec[rownames(exprDatSec)[gsg$goodSamples], colnames(exprDatSec)[gsg$goodGenes]]",
         "   }else{",
         "     exprDatSec <- exprDatSec",
         "   }",
         "}",
         "sft_D2 <- pickSoftThreshold(exprDatSec, powerVector = powers, verbose = 5, networkType = list_input[['signed_D2']])",
         "softPower_D2 <- as.numeric(list_input[['power_D2']])",
         "if (list_input[['cor_D2_P3']] == 'bicor'){",
         "   adjacency_D2 <- adjacency(exprDatSec, power = softPower_D2, type = list_input[['signed_D2']], corFnc = 'bicor', corOptions = list(use = 'p', maxPOutliers =0.1))",
         "}else{",
         "   adjacency_D2 <- adjacency(exprDatSec, power = softPower_D2, type = list_input[['signed_D2']], corOptions = paste(\"method ='\", list_input[['cor_D2_P3']], \"'\", sep = \"\")) ",
         "}",
         "TOM_D2 = TOMsimilarity(adjacency_D2, TOMType = list_input[['signed_D2']])",
         "dissTOM_D2 <- 1-TOM_D2",
         "cmd1_D2 <- cmdscale(as.dist(dissTOM_D2),3)",
         "geneTree_D2 <- hclust(as.dist(dissTOM_D2), method = 'average')",
         "minModuleSize_D2 = list_input[['moduleSize_D2']]",
         "dynamicMods_D2 <- cutreeDynamic(dendro = geneTree_D2, distM = dissTOM_D2,",
         "                        deepSplit = 2, pamRespectsDendro = FALSE,",
         "                        minClusterSize = minModuleSize_D2)",
         "dynamicColors_D2 = labels2colors(dynamicMods_D2)",
         "MEList_D2 = moduleEigengenes(exprDatSec, colors = dynamicColors_D2, excludeGrey = TRUE)",
         "MEs_D2 = MEList_D2$eigengenes",
         "MEDiss_D2 = 1-cor(MEs_D2)",
         "if (ncol(MEs_D2) > 1){",
         "  METree_D2 = hclust(as.dist(MEDiss_D2), method = \"average\") ",
         "}",
         "```\n \n",
         
         "### Scale Free Topology and Soft Power: \n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
         "ggplot(data =sft_D2$fitIndices, aes(x = Power, y = -sign(slope)*SFT.R.sq )) + ",
         "  geom_text(aes(label = Power, color = \"tomato3\"), show.legend =  FALSE) +",
         "  geom_hline(yintercept = 0.9) +",
         "  labs(y = \"Scale Free Topology\", x = \"Soft Threshold (Power)\", title = \"Scale Independence\") +",
         "  theme(legend.position = \"none\")",
         "``` \n \n",
         
         "### Clustering of module eigengenes and Module Information \n",
         " Once the network is created, it is divided in smaller subnetworks called modules which represent groups of highly correlated variables",
         " WGCNA allows the exploration and the in-depth analysis of these modules. It is possible to determine associations with these groups of variables",
         " and to compare these associations to an external traits.\n\n",
         " The following plot represent the clustering of the module eigengenes. It helps to measure the similarity/dissimilarity between two modules. \n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}",
         "if (ncol(MEs_D2) > 1){",
         "  ggdendrogram(METree_D2) + ",
         "    labs(y = \"Height\", title = \"Clustering of module eigengenes\")",
         "}",
         "```\n\n",
         
         "```{r, echo = FALSE, message = FALSE}",
         "datatable(as.data.frame(table(dynamicColors_D2)),",
         " class = 'cell-border stripe',",
         " rownames = FALSE, ",
         " options = list(pageLength = 8, dom = 'tip'),",
         " colnames = c('Module Color' = 'dynamicColors_D2', 'Number of element' = 'Freq'))",
         "```\n\n",
         
         "### Variables Dendrogramme with module colors\n",
         " The following plot is a representation of the variables dendrogramme to measure the similarity/dissimilarity between them with, at the bottom,",
         " the module color of each variables. The modules (subpart of the networks representing the highly correlated variables) are represented with colors",
         " to ease the exploration and the description of these groups of variables.\n",
         "```{r, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 15}",
         "plotDendroAndColors(geneTree_D2, dynamicColors_D2, \"Dynamic Tree Cut\",",
         "            dendroLabels = FALSE, hang = 0.03,",
         "            addGuide = TRUE, guideHang = 0.05,",
         "            main = \"Gene dendrogram and module colors\")",
         "```\n\n",
         paste(vector_input[17], "\n \n"),
         
         #-------------------------------------------------------------------------------------------------------------------------------------------------------
         "# Section 4: Module exploration\n\n",
         "## FIRST DATASET",
         "### Modules correlation to external traits\n",
         "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
         " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
         "```{r, echo = FALSE, fig.height = 30, fig.width = 30}",
         "nSamples <- nrow(exprDat)",
         #"MEs0 = moduleEigengenes(exprDat, dynamicColors)$eigengenes",
         #"MEs = orderMEs(MEs0)",
         "text_matrix_vector <- c()",
         "for (condition in 1:(ncol(sampleAnnot))){",
         "  condition_name <- colnames(sampleAnnot)[condition]",
         "  if (is.numeric(sampleAnnot[,condition_name])){",
         "      moduleTraitCor = cor(MEs, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
         "  }else{",
         "      sampleAnnot2 <- sampleAnnot",
         "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
         "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
         "      moduleTraitCor = cor(MEs, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_P4']])",
         "  }",
         "  moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)",
         "  colnames(moduleTraitCor) <- c(condition_name)",
         "  # Will display correlations and their p-values",
         "  textMatrix = paste(signif(moduleTraitCor, 2), \"\n(\",",
         "        signif(moduleTraitPvalue, 1), \")\", sep = \"\")",
         "  text_matrix_vector <- c(text_matrix_vector, textMatrix)",
         "  dim(textMatrix) = dim(moduleTraitCor)",
         
         "  # create dataframe containing the correlation and the color",
         "  if(condition == 1){",
         "    Condition_df <- data.frame(moduleTraitCor)",
         "  }else{",
         "     Condition_df <- data.frame(Condition_df, moduleTraitCor)",
         "  }",
         "  melted_moduleTraitCor <- melt(moduleTraitCor)",
         "  melted_moduleTraitCor <- data.frame(melted_moduleTraitCor, as.data.frame(substr(names(MEs), 3, 40)))",
         "  colnames(melted_moduleTraitCor)[4] <- \"color\"",
         "}",
         "Condition_df <- setDT(Condition_df, keep.rownames = TRUE)[]",
         "melted_condition_df <- melt(Condition_df, id = 1)",
         "melted_condition_df$label <- as.data.frame(text_matrix_vector)",
         
         "print(ggplot(data = melted_condition_df, aes(x = rn, y = variable, fill = value)) + ",
         "     geom_tile(color = \"white\") +",
         "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
         "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
         "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
         "     theme_minimal() +",
         "     theme(axis.text.x = element_text(angle = 45, vjust = 1,", 
         "                                      size = 10, hjust = 1))+",
         "     geom_text(aes(label = label), color = \"black\", size = 3) +",
         "     coord_fixed() +",
         "     xlab('Module') +",
         "     ylab(''))",
         "```\n\n",
         
         "### Samples contribution to the module eigengenes\n",
         "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
         " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
         " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
         " module and these samples are representative of one specific condition in the dataset.\n\n",
         "```{r}",
         "MEs1 <- data.frame(MEs, rownames(sampleAnnot))",
         
         "colnames(MEs1) <- c(colnames(MEs), \"sampleName\")",
         "for (module in 1:length(MEs)){",
         "  module_name <- substring(names(MEs)[module], 3)\n",
         "  MODS <- paste(\"ME\", module_name, sep = \"\")",
         "  print(ggplot(data = MEs1, aes_string(x = \"sampleName\", y = MODS )) +",
         "    geom_bar(stat = \"identity\", fill = module_name) +", 
         "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
         "}",
         "```\n\n",
         
         
         "```{r, echo = FALSE, message = FALSE}\n",
         "modNames = substring(names(MEs), 3)",
         "geneModuleMembership = as.data.frame(cor(exprDat, MEs, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
         "names(geneModuleMembership) = paste(\"MM\", modNames, sep=\"\")",
         "colnames_used <- c()",
         "for (i in names(sampleAnnot)) {",
         "  if(length(unique(sampleAnnot[,i])) > 1){",
         "    if (is.numeric(sampleAnnot[,i])){",
         "      env = as.data.frame(sampleAnnot[,i]) ",
         "    }else{",
         "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
         "    }",
         "    colnames(env) = i",
         "    colnames_used <- c(colnames_used, i)",
         "    if (i == colnames(sampleAnnot)[1]){",
         "      geneTraitSignificance = as.data.frame(cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
         "    }else{",
         "      geneTraitSignificance = data.frame(geneTraitSignificance, cor(exprDat, env, method= list_input[['cor_P4']], use=\"na.or.complete\"))",
         "    }",
         "  }",
         "}",
         "geneModuleMembership[rowSums(is.na(geneModuleMembership)) != ncol(geneModuleMembership), ] # Remove rows containing only NAs values",
         "geneTraitSignificance[rowSums(is.na(geneTraitSignificance)) != ncol(geneTraitSignificance), ]",
         "```\n",
         
         "### Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n",
         
         
         TMM_P4,
         "## SECOND DATASET",
         
         "### Modules correlation to external traits\n",
         "The following plot represent the correlation between each external trait and each module of the WGCNA network. The heatmap can help finding",
         " modules specific to a specific traits, find the groups of variables associated with a shift in the concentration of one parameter.\n\n",
         "```{r, echo = FALSE, fig.height = 15, fig.width = 15}",
         "nSamples <- nrow(exprDatSec)",
         #"MEs0 = moduleEigengenes(exprDat, dynamicColors)$eigengenes",
         #"MEs = orderMEs(MEs0)",
         "text_matrix_vector_D2 <- c()",
         "for (condition in 1:(ncol(sampleAnnot))){",
         "  condition_name <- colnames(sampleAnnot)[condition]",
         "  if (is.numeric(sampleAnnot[,condition_name])){",
         "      moduleTraitCor_D2 = cor(MEs_D2, sampleAnnot[,condition_name], use = \"p\", method = list_input[['cor_D2_P4']])",
         "  }else{",
         "      sampleAnnot2 <- sampleAnnot",
         "      sampleAnnot2[,condition_name] <- as.factor(sampleAnnot2[, condition_name])",
         "      sampleAnnot2[,condition_name] <- as.numeric(sampleAnnot2[,condition_name])",
         "      moduleTraitCor_D2 = cor(MEs_D2, sampleAnnot2[,condition_name], use = \"p\", method = list_input[['cor_D2_P4']])",
         "  }",
         "  moduleTraitPvalue_D2 = corPvalueStudent(moduleTraitCor_D2, nSamples)",
         "  colnames(moduleTraitCor_D2) <- c(condition_name)",
         "  # Will display correlations and their p-values",
         "  textMatrix_D2 = paste(signif(moduleTraitCor_D2, 2), \"\n(\",",
         "        signif(moduleTraitPvalue_D2, 1), \")\", sep = \"\")",
         "  text_matrix_vector_D2 <- c(text_matrix_vector_D2, textMatrix_D2)",
         "  dim(textMatrix_D2) = dim(moduleTraitCor_D2)",
         
         "  # create dataframe containing the correlation and the color",
         "  if(condition == 1){",
         "    Condition_df_D2 <- data.frame(moduleTraitCor_D2)",
         "  }else{",
         "     Condition_df_D2 <- data.frame(Condition_df_D2, moduleTraitCor_D2)",
         "  }",
         "  melted_moduleTraitCor_D2 <- melt(moduleTraitCor_D2)",
         "  melted_moduleTraitCor_D2 <- data.frame(melted_moduleTraitCor_D2, as.data.frame(substr(names(MEs_D2), 3, 40)))",
         "  colnames(melted_moduleTraitCor_D2)[4] <- \"color\"",
         "}",
         "Condition_df_D2 <- setDT(Condition_df_D2, keep.rownames = TRUE)[]",
         "melted_condition_df_D2 <- melt(Condition_df_D2, id = 1)",
         "melted_condition_df_D2$label <- as.data.frame(text_matrix_vector_D2)",
         
         "print(ggplot(data = melted_condition_df_D2, aes(x = rn, y = variable, fill = value)) + ",
         "     geom_tile(color = \"white\") +",
         "     scale_fill_gradient2(low = \"blue\", high = \"red\", mid = \"white\", ",
         "                          midpoint = 0, limit = c(-1,1), space = \"Lab\", ",
         "                          name=paste(\"Module\n Conditions \nCorrelation\"))+",
         "     theme_minimal() +",
         "     theme(axis.text.x = element_text(angle = 45, vjust = 1,", 
         "                                      size = 10, hjust = 1))+",
         "     geom_text(aes(label = label), color = \"black\", size = 3) +",
         "     coord_fixed() +",
         "     xlab('Module') +",
         "     ylab(''))",
         "```\n\n",
         
         "### Samples contribution to the module eigengenes\n",
         "The following plots explain how each sample participate in the formation of a specific module. In some cases, when only one sample contribute",
         " to the formation of a module, it can be deduce that the module is representative of the expression of this outlier: it can highlight a group",
         " of correlated variables really specific in their expression to a sample. Sometimes, a group of samples may contribute to the formation of a",
         " module and these samples are representative of one specific condition in the dataset.\n\n",
         "```{r}",
         "MEs1_D2 <- data.frame(MEs_D2, rownames(sampleAnnot))",
         
         "colnames(MEs1_D2) <- c(colnames(MEs_D2), \"sampleName\")",
         "for (module in 1:length(MEs_D2)){",
         "  module_name <- substring(names(MEs_D2)[module], 3)\n",
         "  MODS_D2 <- paste(\"ME\", module_name, sep = \"\")",
         "  print(ggplot(data = MEs1_D2, aes_string(x = \"sampleName\", y = MODS_D2 )) +",
         "    geom_bar(stat = \"identity\", fill = module_name) +", 
         "    theme(axis.text.x = element_text(angle = 90, hjust = 1)))",
         "}",
         "```\n\n",
         
         
         "```{r, echo = FALSE, message = FALSE}\n",
         "modNames = substring(names(MEs_D2), 3)",
         "geneModuleMembership_D2 = as.data.frame(cor(exprDatSec, MEs_D2, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
         "names(geneModuleMembership_D2) = paste(\"MM\", modNames, sep=\"\")",
         "colnames_used <- c()",
         "for (i in names(sampleAnnot)) {",
         "  if(length(unique(sampleAnnot[,i])) > 1){",
         "    if (is.numeric(sampleAnnot[,i])){",
         "      env = as.data.frame(sampleAnnot[,i]) ",
         "    }else{",
         "      env = as.data.frame(as.numeric(as.factor(sampleAnnot[,i])))",
         "    }",
         "    colnames(env) = i",
         "    colnames_used <- c(colnames_used, i)",
         "    if (i == colnames(sampleAnnot)[1]){",
         "      geneTraitSignificance_D2 = as.data.frame(cor(exprDatSec, env, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
         "    }else{",
         "      geneTraitSignificance_D2 = data.frame(geneTraitSignificance_D2, cor(exprDatSec, env, method= list_input[['cor_D2_P4']], use=\"na.or.complete\"))",
         "    }",
         "  }",
         "}",
         "geneModuleMembership_D2[rowSums(is.na(geneModuleMembership_D2)) != ncol(geneModuleMembership_D2), ] # Remove rows containing only NAs values",
         "geneTraitSignificance_D2[rowSums(is.na(geneTraitSignificance_D2)) != ncol(geneTraitSignificance_D2), ]",
         "```\n",
         
         "### Module Membership vs Trait Significance {.tabset .tabset-fade .tabset-pills} \n",
         
         TMM_D2_P4,
         paste("\n\n", vector_input[18], "\n \n")),
         #----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
         "# Section 5: Multi-Omics Analysis:\n",
         "```{r, echo = FALSE, message = FALSE}\n",
         "colnames_exprDat_Unique <- c()",
         "colnames_exprDatSec_Unique <- c()",
         "for (col in 1:ncol(exprDat)){",
         " if (length(unique(exprDat[,col])) == 1){",
         "   colnames_exprDat_Unique <- c(colnames_exprDat_Unique, colnames(exprDat)[col])",
         " }",
         "}",
         "exprDat_NonUnique <- exprDat[, which(colnames(exprDat) %!in% colnames_exprDat_Unique)]",
         "for (col in 1:ncol(exprDatSec)){",
         " if (length(unique(exprDatSec[,col])) == 1){",
         "   colnames_exprDatSec_Unique <- c(colnames_exprDatSec_Unique, colnames(exprDatSec)[col])",
         " }",
         "}",
         "exprDatSec_NonUnique <- exprDatSec[, which(colnames(exprDatSec) %!in% colnames_exprDatSec_Unique)]",
         "df1_df2 <- list()",
         "df1_df2[[\"df1\"]] <- t(as.data.frame(exprDat_NonUnique))",
         "exprDatSec_NonUnique[which(is.na(exprDatSec_NonUnique)),] <- 0",
         "df1_df2[[\"df2\"]] <- t(as.data.frame(exprDatSec_NonUnique))",
         "mcoia <- mcia(df1_df2, nsc = F)",
         "```\n\n",
         "## General Co-inertia {.tabset .tabset-fade .tabset-pills}\n\n ",
         coinertia_text,
         "## General Procrustes Analysis {.tabset .tabset-fade .tabset-pills} \n\n",
         procrustes_text,
         
         "## Heatmap representing the correlation between the modules of each network \n\n",
         "```{r, fig.width = 15, fig.height = 20, echo = FALSE, message = FALSE}\n",
         "corr_MEs_D1D2 <- cor(MEs, MEs_D2, use = \"p\", method = \"spearman\")",
         "corr_MEs_D1D2 <- as.data.frame(corr_MEs_D1D2)",
         "row.order <- hclust(dist(corr_MEs_D1D2, method = \"euclidean\"), method = \"ward.D\")$order ",
         "col.order <- hclust(dist(t(corr_MEs_D1D2), method = \"euclidean\"), method = \"ward.D\")$order",
         "corr_MEs_D1D2 <- corr_MEs_D1D2[row.order, col.order]",
         "corr_MEs_D1D2 <- t(corr_MEs_D1D2)",
         
         "main_heatmap(corr_MEs_D1D2, name = \"Correlation between MEs\") %>%",
         "  add_row_labels() %>%",
         "  add_col_labels() %>%",
         "  add_col_clustering() %>%",
         "  add_row_clustering() %>%",
         "  add_col_title(\"Modules of the first dataset\") %>% ",
         "  add_row_title(\"Modules of the second dataset\") ",
         
         "```\n\n",
         
         "## Specific heatmap between modules of different networks \n",
         "In this section, correlation heatmap between the variables of the modules of each heatmap have been realized on ",
         "modules known to be highly correlated to each other. \n",
         
         "```{r, fig.width = 15, fig.height = 15, echo = FALSE, message = FALSE}\n",
         "for (modules in 1:ncol(corr_MEs_D1D2)){",
         "  for(modules_D2 in 1:nrow(corr_MEs_D1D2)){",
         "    if (abs(corr_MEs_D1D2[modules_D2, modules]) >= list_input['minimalCorrelation']){",
         "       module_name_D1 = substr(colnames(corr_MEs_D1D2)[modules], 3, 40)",
         "       module_name_D2 = substr(rownames(corr_MEs_D1D2)[modules_D2], 3, 40)",
         "       print(paste('Dataset 1 : Module', module_name_D1, '\n'))",
         "       print(paste('Dataset 2 : Module', module_name_D2, '\n'))",
         "        modGenes_D1 = (dynamicColors == module_name_D1)",
         "        modGenes_D2 = (dynamicColors_D2 == module_name_D2)",
         "        sub_exprDat <- exprDat[modGenes_D1]",
         "        sub_exprDatSec <- exprDatSec[,modGenes_D2]",
         "        corr_expr_1 <- cor(sub_exprDat, sub_exprDatSec, use = \"p\", method = \"spearman\")",
         "        corr_expr_1 <- as.data.frame(corr_expr_1)",
         "        row.order <- hclust(dist(corr_expr_1, method = \"euclidean\"), method = \"ward.D\")$order ",
         "        col.order <- hclust(dist(t(corr_expr_1), method = \"euclidean\"), method = \"ward.D\")$order",
         "        corr_expr_new <- corr_expr_1[row.order, col.order]",
         "        corr_expr_new <- t(corr_expr_new)",
         "        taxon_annotation <- taxTable_relAb[which(taxTable_relAb[[\"rn\"]] %in% colnames(corr_expr_new)),]",
         "        taxon_group <- as.vector(taxon_annotation[[colnames(taxon_annotation)[5]]])",
         "        my_group=as.numeric(as.factor(taxon_group))",
         "        my_col=brewer.pal(9, \"Set1\")[my_group]",
         "        heatmap(corr_expr_new, ColSideColors = my_col, margins = c(15,15))",
         
         "        legend(\"topright\", ",    
         "           legend = unique(taxon_group),",
         "           col = unique(my_col), ",
         "           lty = 1,",             
         "           lwd = 5,",           
         "           cex=.7",
         "        )",
         "        corr_expr_1[abs(corr_expr_1) < 0.5] <- 0",
         "        corr_expr_1[abs(corr_expr_1) >= 0.5] <- 1",
         
         "        if (nchar(rownames(corr_expr_1)[5]) >20){",
         "          for (row in 1:nrow(corr_expr_1)){",
         "            rownames(corr_expr_1)[row] <- paste(\"OTU\", row, sep=\"\")",
         "          }",
         "        }",
         "        corr_expr_1 <- t(corr_expr_1)",
         "        bip = network(corr_expr_1,",
         "          matrix.type = \"bipartite\",",
         "          ignore.eval = FALSE,",
         "          names.eval = \"weights\")",
         "        col = c(\"actor\" = \"red\", \"event\" = \"blue\")",
         "        print(ggnet2(bip, color = \"mode\", palette = col, label = TRUE, layout.exp = 0.25, shape= \"mode\") +",
         "          theme(legend.position=\"none\")) ",    
         "    }",
         "  }",
         "}",
         "```\n\n",
         vector_input[19],
                   fichier)
      
      }
    }
  }
    
  
  
  close(fichier)
}